<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReviveSubs - نظام إدارة فريق الترجمة</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="handleGoogleApiLibraryLoad()"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --text-main: #f7fafc; 
            --text-secondary: #a0aec0; 
            --border-color: #4a5568; 

            --header-gradient-start: #0f172a;
            --header-gradient-end: #1e293b;
            
            --footer-text: var(--text-secondary);
            --footer-border: var(--border-color);

            /* Report specific, used in JS for inline styles & print */
            --report-header-bg-var: #2c3e50; 
            --report-table-th-bg-var: #34495e; 

            --money-positive-bg: rgba(16, 185, 129, 0.2);
            --money-negative-bg: rgba(239, 68, 68, 0.2);
            --money-zero-bg: rgba(245, 159, 11, 0.2);

            /* Accents */
            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6; 
            --accent-green: #10b981; 
            --accent-yellow: #f59e0b; 
            --accent-red: #ef4444; 

            /* Shadows */
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.2), 0 1px 2px 0 rgba(0, 0, 0, 0.16);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.16);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.2);

            /* Gradients */
            --gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            --gradient-green: linear-gradient(135deg, var(--accent-green) 0%, #047857 100%);
            --gradient-red: linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
            --gradient-yellow: linear-gradient(135deg, var(--accent-yellow) 0%, #d97706 100%);
            --gradient-secondary: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);

            /* Backgrounds from user's new variables (Primary theme variables) */
            --bg-primary-user: #0f0f0f; 
            --bg-secondary-user: #1a1a1a; 
            --bg-card-user: #242424; 
            --bg-hover-user: #2a2a2a; 
            --input-bg: #4a5568;

            /* Card Specific Styles (merged) */
            --card-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-primary-user); 
            color: var(--text-main);
            line-height: 1.6;
            direction: rtl;
            overflow-x: hidden;
            padding-bottom: 80px; /* Space for global actions toolbar */
        }

        #appContent { 
            padding-top: 0; 
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .hidden { display: none !important; }

        .header {
            color: var(--text-main);
            padding: 0; 
            box-shadow: var(--shadow-xl);
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 280px; 
            overflow: hidden;
            background-size: cover; 
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out, height 0.3s ease-in-out;
            position: relative; 
        }

        .header::before { 
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.4) 0%, rgba(30, 41, 59, 0.3) 50%, rgba(15, 23, 42, 0.4) 100%);
            z-index: 1; 
        }
        .header.has-background-image::before {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.55) 0%, rgba(30, 41, 59, 0.45) 50%, rgba(15, 23, 42, 0.55) 100%);
        }
        .header-content {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            z-index: 2; width: 100%; max-width: 1600px; 
            margin: 0 auto; padding: 10px 20px;
        }
        .header-social-links {
            position: absolute; top: 15px; right: 25px;
            display: flex; gap: 12px; z-index: 3; 
        }
        .header-social-links a {
            color: var(--text-main); font-size: 1.1em;
            transition: all 0.25s ease-out;
            background-color: rgba(0, 0, 0, 0.35); border-radius: 50%;
            width: 32px; height: 32px;
            display: inline-flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .header-social-links a:hover {
            color: var(--accent-purple); background-color: rgba(139, 92, 246, 0.3); 
            transform: scale(1.12) translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.25);
        }

        .nav-tabs { display: flex; background-color: var(--bg-secondary-user); border-radius: 12px; overflow: hidden; margin-top: 20px; box-shadow: var(--shadow-md); }
        .nav-tab { flex: 1; padding: 16px 20px; text-align: center; cursor: pointer; background-color: var(--bg-secondary-user); border: none; font-size: 1.05em; font-weight: 500; transition: all 0.3s ease; position: relative; color: var(--text-main); }
        .nav-tab:hover { background-color: var(--bg-hover-user); }
        .nav-tab.active { background: var(--gradient-blue); color: var(--text-main); }
        .nav-tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--accent-blue); }

        .sub-nav-tabs { display: flex; justify-content: center; margin-bottom: 20px; background-color: var(--bg-secondary-user); padding: 10px; border-radius: 8px; gap: 10px; }
        .sub-nav-tab { padding: 10px 20px; border: none; border-radius: 6px; background-color: var(--input-bg); color: var(--text-main); cursor: pointer; transition: background-color 0.3s ease; }
        .sub-nav-tab:hover { background-color: var(--accent-blue); }
        .sub-nav-tab.active { background-color: var(--accent-purple); font-weight: bold; }

        .tab-content { background-color: var(--bg-secondary-user); padding: 30px; border-radius: 12px; box-shadow: var(--shadow-md); min-height: 500px; margin-top: 20px; }
        .tab-pane { display: none; animation: fadeIn 0.4s ease-in-out; }
        .tab-pane.active { display: block; }
        .project-sub-view { display: none; } 
        .project-sub-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Styles for projectDetailsModal, kept for its usage */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 0.85em; }
        .info-item { display: flex; }
        .info-item label { font-weight: 500; color: var(--text-secondary); margin-left: 5px; white-space: nowrap; }
        .info-item span { color: var(--text-main); word-break: break-word; }
        .cost-breakdown .cost-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }
        .cost-breakdown .cost-item span:first-child { color: var(--text-secondary); }
        .cost-breakdown .cost-item.total { font-weight: 600; border-top: 1px solid var(--border-color); padding-top: 5px; margin-top: 5px; }
        .project-notes-modal-content p { font-size: 0.9em; line-height: 1.5; color: var(--text-secondary); white-space: pre-wrap; }
        .project-modal-section h5 { font-size: 1em; margin-bottom: 8px; color: var(--text-main); }

        .action-btn.primary { background-color: var(--accent-blue); }
        .action-btn.secondary { background-color: var(--text-secondary); } /* Not a gradient to differentiate */
        .action-btn.danger { background-color: var(--accent-red); }
        .action-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .project-card-link-btn:hover { color: var(--accent-blue); }
        .project-card-link-btn i { vertical-align: middle; }
        .status-indicator.active, .status-indicator.jar { background-color: var(--accent-green); color: var(--text-main); }
        .status-indicator.upcoming, .status-indicator.qryb { background-color: var(--accent-yellow); color: var(--bg-primary-user); }
        .status-indicator.completed, .status-indicator.mktml { background-color: var(--accent-blue); color: var(--text-main); }
        .status-indicator.stopped, .status-indicator.mtqf { background-color: var(--accent-red); color: var(--text-main); }

        .circular-progress svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .circular-progress .circle-bg { fill: none; stroke: var(--border-color); stroke-width: 3; }
        .circular-progress .circle { fill: none; stroke: var(--accent-purple); stroke-width: 3; stroke-linecap: round; transition: stroke-dasharray 0.3s ease; }
        .progress-text .completed, .progress-text .total { font-size: 0.9em; }
        .progress-text .completed { color: var(--accent-blue); }
        .progress-text .separator { color: var(--text-secondary); margin: 0 1px; font-size: 0.8em; }
        .progress-text .total { color: var(--text-secondary); }
        .circular-progress { width: 60px; height: 60px; position: relative; }
        .episode-controls { display: flex; align-items: center; gap: 5px; position: relative; }
        .episode-control-btn { width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--border-color); background-color: var(--bg-secondary-user); color: var(--text-main); font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; line-height: 1; }
        .episode-control-btn:hover { background-color: var(--accent-purple); border-color: var(--accent-purple); transform: scale(1.1); }
        .episode-control-btn:active { transform: scale(0.95); }
        .episode-control-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .episode-control-btn:disabled:hover { background-color: var(--bg-secondary-user); border-color: var(--border-color); transform: none; }
        .project-status-widget { min-width: 120px; }
        .project-team-avatars .avatar-group img:hover { transform: scale(1.2); z-index: 1; }
        .btn-icon { background: none; border: none; color: var(--text-secondary); font-size: 1.5em; cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s; }
        .btn-icon:hover { background-color: rgba(255,255,255,0.1); color: var(--accent-purple); }

        .card { background: var(--bg-card-user); border-radius: 12px; box-shadow: var(--shadow); padding: 24px; margin-bottom: 20px; transition: var(--card-transition); border: 1px solid var(--border-color); }
        .card:hover { box-shadow: var(--shadow-md); border-color: var(--accent-purple); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 1.25em; font-weight: 600; color: var(--text-main); }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.95em; font-weight: 500; cursor: pointer; transition: all 0.3s ease; margin: 0 5px; display: inline-flex; align-items: center; gap: 8px; color: var(--text-main); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-sm { padding: 6px 12px; font-size: 0.85em; }
        .btn-primary { background: var(--gradient-blue); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-success { background: var(--gradient-green); }
        .btn-danger { background: var(--gradient-red); }
        .btn-warning { background: var(--gradient-yellow); color: var(--bg-primary-user);  }
        .btn-secondary { background: var(--gradient-secondary); }
        .btn-info { background: var(--gradient-blue); } 

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-main); }
        .form-control { width: 100%; padding: 10px 14px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1em; transition: all 0.3s ease; background-color: var(--input-bg); color: var(--text-main); }
        .form-control:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }

        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 12px; box-shadow: var(--shadow); background-color: var(--bg-card-user); }
        table { width: 100%; border-collapse: collapse; background-color: var(--bg-card-user); table-layout: auto; }
        th { background: linear-gradient(135deg, var(--bg-secondary-user) 0%, var(--bg-primary-user) 100%); color: var(--text-main); padding: 14px 12px; text-align: right; font-weight: 600; position: sticky; top: 0; z-index: 10; white-space: nowrap; border-bottom: 1px solid var(--border-color); }
        td { padding: 12px 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; white-space: normal; word-break: break-word; }
        tr:hover { background-color: var(--bg-hover-user); }

        .money-positive { color: var(--accent-green); font-weight: 600; }
        .money-zero { color: var(--accent-yellow); font-weight: 600; }
        .money-negative { color: var(--accent-red); font-weight: 600; }
        .stat-value.money-positive, .stat-value.money-zero, .stat-value.money-negative { padding: 2px 6px; border-radius: 4px; }
        .stat-value.money-positive { background-color: var(--money-positive-bg); }
        .stat-value.money-zero { background-color: var(--money-zero-bg); }
        .stat-value.money-negative { background-color: var(--money-negative-bg); }

        .icon { width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-left: 5px; margin-right: 0; }
        .member-social-links a { margin: 0 4px; color: var(--text-secondary); }
        .member-social-links a:hover { color: var(--accent-blue); }
        .member-social-links svg { width: 20px; height: 20px; vertical-align: middle; fill: currentColor; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.65); backdrop-filter: blur(5px); animation: fadeIn 0.3s ease; }
        .modal-content { background-color: var(--bg-card-user); margin: 3% auto; padding: 0; border-radius: 16px; width: 90%; max-width: 800px; animation: slideInModal 0.3s ease; box-shadow: var(--shadow-lg); }
        @keyframes slideInModal { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background: linear-gradient(135deg, var(--bg-secondary-user) 0%, var(--bg-primary-user) 100%); color: var(--text-main); padding: 20px 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.5em; font-weight: 600; }
        .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border-color); text-align: left; display: flex; justify-content: flex-start; gap: 10px; }
        .close { color: var(--text-main); font-size: 28px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; line-height: 1; }
        .close:hover { transform: rotate(90deg); color: var(--accent-red); }

        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background-color: var(--bg-secondary-user); border-radius: 12px; flex-wrap: wrap; gap: 10px; }
        .search-box { padding: 10px 16px; border: 2px solid var(--border-color); border-radius: 8px; width: 300px; font-size: 0.95em; background-color: var(--input-bg); color: var(--text-main); }
        .search-box:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        .toolbar .form-control { width: auto; min-width: 200px; }

        .footer { text-align: center; padding: 30px 20px; margin-top: 50px; color: var(--footer-text); border-top: 1px solid var(--footer-border); }

        .text-center { text-align: center; }
        .text-sm { font-size: 0.875em; }
        .text-muted { color: var(--text-secondary); } 
        .flex { display: flex; }
        .gap-10 { gap: 10px; }
        .gap-15 { gap: 15px; }
        .gap-20 { gap: 20px; }
        .flex-wrap { flex-wrap: wrap; }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .ai-loading-indicator { font-size: 0.9em; color: var(--text-secondary); margin-right: 10px; }

        #imagePreviewModal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        #imagePreviewModal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
        #imagePreviewModal .close-preview { position: absolute; top: 20px; right: 35px; left: auto; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }

        .spinner { border: 4px solid rgba(59,130,246,0.2); border-top: 4px solid var(--accent-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .lazy-load-sentinel { height: 20px; width: 100%; }

        .alert { position: fixed; top: 20px; left: 20px; padding: 15px 20px; border-radius: 8px; color: var(--text-main); font-weight: 500; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10001; animation: slideInAlert 0.3s ease, fadeOutAlert 0.3s ease 2.7s forwards; }
        .alert-success { background-color: var(--accent-green); }
        .alert-danger { background-color: var(--accent-red); }
        .alert-warning { background-color: var(--accent-yellow); color: var(--bg-primary-user); }
        .alert-info { background-color: var(--accent-blue); }
        @keyframes slideInAlert { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOutAlert { from { opacity: 1; } to { opacity: 0; } }

        /* Global Actions Toolbar & Dropdowns */
        .global-actions-container {
            position: fixed;
            bottom: 20px;
            left: 20px; /* For RTL, this will appear on the bottom-left */
            z-index: 1500;
            display: flex;
            gap: 10px;
            background-color: var(--bg-secondary-user);
            padding: 10px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            align-items: center;
        }
        .global-actions-container .btn-icon {
            font-size: 1.3em; /* Slightly smaller for this bar */
            padding: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .global-actions-container .search-box { /* Style for the global search input */
            width: 250px; /* Adjust as needed */
            padding: 8px 12px;
            font-size: 0.9em;
            margin-left: 5px; /* For RTL, search input to the left of search button */
        }
        .dropdown-container {
            position: relative;
            display: inline-block;
        }
        .dropdown-menu {
            /* display: none; Will be toggled by JS, using .hidden class */
            position: absolute;
            background-color: var(--bg-card-user);
            min-width: 180px;
            box-shadow: var(--shadow-lg);
            z-index: 1600; /* Above global actions toolbar */
            border-radius: 8px;
            padding: 5px 0;
            bottom: 100%; /* Position above the button */
            margin-bottom: 5px; /* Space between button and menu */
            left: 50%;
            transform: translateX(-50%);
            border: 1px solid var(--border-color);
        }
        .dropdown-menu a {
            color: var(--text-main);
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            font-size: 0.9em;
            white-space: nowrap;
        }
        .dropdown-menu a:hover {
            background-color: var(--bg-hover-user);
            color: var(--accent-blue);
        }


        @media (max-width: 768px) {
            .header-social-links { display: none; } 
            .nav-tabs { flex-direction: column; }
            .toolbar { flex-direction: column; gap: 15px; align-items: stretch; }
            .toolbar > div { width: 100%; }
            .toolbar .form-control { width: 100%; }
            .modal-content { width: 95%; margin: 5% auto; }
            .modal-body > form > div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; gap: 10px !important; }
            .stats-hero-section, .charts-section, .active-projects-kanban .kanban-board, .financial-overview .finance-cards { grid-template-columns: 1fr !important; }
            .sub-nav-tabs { flex-direction: column; }
            .global-actions-container {
                flex-direction: row; /* Keep row for buttons */
                flex-wrap: wrap; /* Allow wrapping on small screens */
                justify-content: center;
                bottom: 10px; left: 10px; right: 10px; width: auto;
            }
            .global-actions-container .search-box { width: calc(100% - 50px); margin-left: 0; margin-right: 5px;}
        }

        .cards-grid, .projects-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(340px, calc(100% - 20px)), 1fr)); gap: 24px; margin-top: 20px; padding: 0; box-sizing: border-box; }
        @media (min-width: 1600px) { .cards-grid, .projects-grid, #archiveCardGrid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        @media (min-width: 1200px) and (max-width: 1599px) { .cards-grid, .projects-grid, #archiveCardGrid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        @media (min-width: 768px) and (max-width: 1199px) { .cards-grid, .projects-grid, #archiveCardGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (max-width: 767px) { .cards-grid, .projects-grid, #archiveCardGrid { grid-template-columns: 1fr; gap: 20px; } }

        .member-card, .project-card { width: 100%; min-width: 0; box-sizing: border-box; display: flex; flex-direction: column; height: 100%; cursor: default; animation: slideIn 0.4s ease-out; }
        .member-card *, .project-card * { min-width: 0; box-sizing: border-box; }
        .member-card .card-header { padding: 16px; background-color: rgba(255,255,255,0.03); display: flex; align-items: center; gap: 15px; }
        .member-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-left: 0; border: 2px solid var(--border-color); cursor: pointer; flex-shrink: 0; }
        .member-info { flex: 1; min-width: 0; }
        .member-info h3 { margin: 0 0 4px 0; font-size: 1.2em; font-weight: 600; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .member-roles { display: flex; flex-wrap: wrap; gap: 6px; }
        .role-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 500; color: var(--text-main); text-transform: capitalize; }
        .role-badge.translator { background-color: var(--accent-blue); }
        .role-badge.editor { background-color: var(--accent-green); }
        .role-badge.timer { background-color: var(--accent-yellow); color: var(--bg-primary-user); } 
        .role-badge.subtitler { background-color: #5a6268; }
        .card-actions { margin-left: auto; padding-left: 10px; flex-shrink: 0; }
        .member-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .card-stats { padding: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; border-bottom: 1px solid var(--border-color); }
        .stat-item { text-align: center; padding: 8px; background-color: rgba(255,255,255,0.03); border-radius: 8px; }
        .stat-label { display: block; font-size: 0.8em; color: var(--text-secondary); margin-bottom: 4px; }
        .stat-value { font-size: 1.1em; font-weight: 600; color: var(--text-main); }
        .card-footer { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.02); border-top: 1px solid var(--border-color); margin-top: auto; gap: 10px; flex-wrap: wrap; }
        .btn-text { background: none; border: none; color: var(--accent-blue); font-weight: 500; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: background-color 0.2s, color 0.2s; white-space: nowrap; font-size: 0.85em; }
        .btn-text:hover { background-color: rgba(59, 130, 246, 0.1); color: var(--accent-blue); }
        .social-links { display: flex; gap: 8px; flex-shrink: 0; }
        .social-links a svg { width: 18px; height: 18px; }
        @media (max-width: 400px) { .member-card .card-footer { flex-direction: column; gap: 10px; align-items: stretch; } .social-links { justify-content: center; } }

        .project-title { font-size: 1.15em; font-weight: 600; margin: 0; color: var(--text-main); line-height: 1.4; overflow: visible; text-overflow: initial; display: block; white-space: normal; word-wrap: break-word; hyphens: auto; min-height: 2.8em; }
        .project-card .project-header { display: flex; padding: 18px; gap: 18px; min-height: 180px; align-items: flex-start; }
        .project-poster { position: relative; flex-shrink: 0; width: 90px; height: 135px; }
        .project-poster img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; }
        .project-type-badge { position: absolute; top: 5px; right: 5px; background-color: var(--accent-purple); color: var(--text-main); padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: 500; }
        .project-main-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 8px; }
        .project-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.75em; color: var(--text-secondary); margin: 0; }
        .project-meta .meta-item { display: flex; align-items: center; gap: 3px; white-space: nowrap; }
        .project-meta .meta-item i { color: var(--accent-blue); font-size: 0.9em; }
        .project-genres { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .genre-tag { background-color: var(--bg-secondary-user); color: var(--text-secondary); padding: 2px 6px; border-radius: 10px; font-size: 0.7em; }
        .project-status-widget { text-align: center; padding-left: 10px; border-left: 1px solid var(--border-color); min-width: 80px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .status-indicator { font-weight: 600; padding: 3px 8px; border-radius: 6px; font-size: 0.75em; display: inline-block; white-space: nowrap; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; font-weight: 600; display: flex; align-items: baseline; justify-content: center; }
        .progress-label { font-size: 0.7em; color: var(--text-secondary); margin: 0; }
        .project-team { padding: 15px 20px; border-bottom: 1px solid var(--border-color); position: relative; /* For cost popup */ }
        .project-team h4 { font-size: 1.1em; margin-bottom: 10px; color: var(--text-main); }
        .project-team-avatars { display: flex; align-items: center; gap: 10px; }
        .project-team-avatars .btn-team-details { margin-right: 0; margin-left: auto; flex-shrink: 0; }
         .project-team-avatars .project-cost-calculator-btn { /* Style for new calculator button */
            margin-left: 5px; /* Space it from team button */
            padding: 6px 10px; /* Align size with btn-sm */
            background-color: var(--accent-blue);
            color: var(--text-main);
        }
        .project-team-avatars .project-cost-calculator-btn:hover {
            background-color: var(--accent-purple);
        }
        .project-team-avatars .avatar-group { display: flex; flex-shrink: 0; }
        .project-team-avatars .avatar-group img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-card-user); margin-right: -10px; transition: transform 0.2s; cursor: pointer; }
        
        /* Project Cost Details Popup */
        .project-cost-details-popup {
            position: absolute;
            top: 100%; /* Position below the project-team section */
            right: 0; /* Align to the right of the card or relative to parent */
            width: calc(100% - 40px); /* Adjust width as needed, considering card padding */
            max-width: 300px;
            background-color: var(--bg-secondary-user);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            padding: 15px;
            z-index: 100;
            margin: 10px auto 0; /* Centered below with some margin */
            font-size: 0.9em;
        }
        .project-cost-details-popup h4 {
            font-size: 1.1em;
            color: var(--accent-purple);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .project-cost-details-popup .cost-popup-content p {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .project-cost-details-popup .cost-popup-content strong {
            color: var(--text-main);
        }
        .project-cost-details-popup .close-cost-popup {
            position: absolute;
            top: 5px;
            left: 10px; /* RTL adjusted */
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .project-cost-details-popup .close-cost-popup:hover {
            color: var(--accent-red);
        }


        .project-actions { padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; align-items: center; flex-wrap: wrap; background-color: var(--bg-secondary-user); margin-top: auto; }
        #archiveCardGrid .project-actions { flex-wrap: wrap; justify-content: space-between; padding: 10px; box-sizing: border-box; }
        #archiveCardGrid .action-btn { flex: 1 1 calc(50% - 4px); min-width: 90px; }
        #archiveCardGrid .project-card-link-btn { margin: 0 5px; }
        #archiveCardGrid .archive-btn { margin-right: 0; margin-left: auto; }
        #archiveCardGrid .project-card-checkbox { display: none !important; }
        .action-btn { flex: 1 1 calc(50% - 4px); min-width: 100px; padding: 8px 10px; border-radius: 8px; font-size: 0.85em; font-weight: 500; cursor: pointer; transition: background-color 0.2s, transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; color: var(--text-main); border: none; text-align: center; }
        .action-btn.danger { flex: 1 1 auto; order: 3; }
        .project-card-link-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.1em; cursor: pointer; padding: 5px 8px; transition: color 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .project-card-checkbox { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; margin-left: auto; }
        .project-card-details-btn { flex: 1 1 calc(50% - 4px); min-width: 100px; order: 2; background-color: var(--accent-purple); color: white; font-weight: bold; border: none; border-radius: 8px; padding: 10px; transition: background-color 0.3s ease; }
        .project-card-details-btn:hover { background-color: #7c3aed; color: #fff; transform: translateY(-2px); }
        @media (max-width: 450px) {
            .project-card .project-header { padding: 15px; gap: 12px; min-height: auto; flex-direction: column; text-align: center; }
            .project-poster { width: 100px; height: 150px; margin: 0 auto; }
            .project-main-info { text-align: center; }
            .project-status-widget { border-left: none; border-top: 1px solid var(--border-color); padding-top: 15px; padding-left: 0; width: 100%; }
            .project-title { font-size: 1.1em; min-height: auto; }
            .project-actions { padding: 12px; gap: 8px; }
            .action-btn { flex: 1 1 calc(50% - 4px); min-width: auto; padding: 10px 8px; font-size: 0.85em; }
            .project-cost-details-popup { width: calc(100% - 20px); right: 10px; left: 10px; margin: 10px auto; }

        }
        @media (max-width: 350px) { /* Further consolidate for very small screens if needed */ }

        /* Dashboard Specific Styles */
        #dashboardContent { display: flex; flex-direction: column; gap: 30px; padding: 20px 0; width: 100%; box-sizing: border-box; }
        #dashboardContent > div { width: 100%; box-sizing: border-box; }
        #dashboardContent .card { width: 100%; min-width: unset; max-width: unset; margin: 0; box-sizing: border-box; }
        .section-header { font-size: 1.3em; color: var(--text-main); margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid var(--accent-purple); display: flex; align-items: center; gap: 10px; clear: both; }
        #dashboardContent > div:first-child .section-header:first-child { margin-top: 0; }
        .section-header i { color: var(--accent-purple); }
        .stats-hero-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; width: 100%; }
        .main-stat-card { padding: 25px; border-radius: 16px; display: flex; align-items: center; gap: 20px; transition: all 0.3s ease; position: relative; overflow: hidden; background: var(--bg-card-user); border: 1px solid var(--border-color); box-sizing: border-box; min-height: 140px; cursor: pointer; }
        .main-stat-card.gradient-purple { background: var(--gradient-purple); color: var(--text-main); border: none; }
        .main-stat-card.gradient-blue { background: var(--gradient-blue); color: var(--text-main); border: none; }
        .main-stat-card.gradient-green { background: var(--gradient-green); color: var(--text-main); border: none; }
        .main-stat-card.gradient-red { background: var(--gradient-red); color: var(--text-main); border: none; }
        .main-stat-card::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); opacity: 0; transition: opacity 0.3s ease; }
        .main-stat-card:hover::before { opacity: 1; }
        .main-stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-xl); }
        .stat-icon-wrapper { background-color: rgba(255,255,255,0.15); border-radius: 50%; width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .stat-icon-wrapper i { font-size: 30px; color: rgba(255,255,255,0.95); }
        .stat-content { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .stat-number { font-size: 2.8em; font-weight: 700; margin: 0; line-height: 1; color: var(--text-main); }
        #dbCompletedEpisodes { color: #f0f0f0 !important; } /* Specific override if needed */
        .main-stat-card .stat-label { font-size: 1.1em; color: rgba(255,255,255,0.85); margin: 5px 0; } /* Scoped to main-stat-card */
        .stat-details { font-size: 0.9em; color: rgba(255,255,255,0.7); margin-top: 8px; }
        .charts-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; width: 100%; }
        .chart-card { padding: 20px; height: 350px; background: var(--bg-card-user); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color); position: relative; box-sizing: border-box; display: flex; flex-direction: column; }
        .chart-card h3 { font-size: 1.1em; margin: 0 0 20px 0; color: var(--text-main); display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .chart-card canvas { max-height: calc(100% - 50px) !important; height: auto !important; width: 100% !important; flex: 1; }
        
        /* Recent Activity Section on Dashboard */
        #recentActivitySection .card { padding: 20px; }
        #recentActivitySection ul { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; }
        #recentActivitySection li {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        #recentActivitySection li:last-child { border-bottom: none; }
        #recentActivitySection li:hover { background-color: var(--bg-hover-user); }
        #recentActivitySection li .activity-time { font-size: 0.8em; color: var(--text-main); margin-left: 10px; white-space: nowrap; }


        .financial-summaries-section { margin-top: 20px; width: 100%; clear: both; }
        .financial-summary-card { padding: 25px; margin-bottom: 20px; background: linear-gradient(135deg, var(--bg-card-user) 0%, rgba(36, 36, 36, 0.6) 100%); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color); box-sizing: border-box; width: 100%; }
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 10px; }
        .summary-header h4 { margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: 8px; }
        .summary-badge { padding: 5px 15px; border-radius: 20px; font-size: 0.85em; font-weight: 500; background: var(--gradient-secondary); color: var(--text-main); }
        .summary-badge.anime { background: var(--gradient-purple); }
        .summary-badge.series { background: var(--gradient-green); }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; width: 100%; }
        .summary-item { text-align: center; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px; transition: all 0.3s ease; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .summary-item:hover { background: rgba(255,255,255,0.05); transform: translateY(-2px); }
        .summary-item label { display: block; font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; } /* Scoped */
        .summary-item .amount, .summary-item .value { font-size: 1.4em; font-weight: 600; color: var(--text-main); }
        .financial-summary-card.total-summary { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border: 1px solid rgba(139, 92, 246, 0.3); } /* Ensure .total-summary exists */
        
        .detailed-stats-section { margin-top: 20px; width: 100%; clear: both; }
        .detailed-stats-section .card { box-sizing: border-box; width: 100%; }
        .detailed-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; padding: 25px; width: 100%; box-sizing: border-box; }
        .stat-box { padding: 20px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease; min-height: 150px; box-sizing: border-box; }
        .stat-box:hover { background: rgba(255,255,255,0.05); border-color: var(--accent-purple); }
        .stat-box h5 { font-size: 1em; color: var(--accent-purple); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .stat-box ul { list-style: none; padding: 0; margin: 0; }
        .stat-box li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .stat-box li:last-child { border-bottom: none; }
        .stat-box li span { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .stat-box li strong { color: var(--text-main); flex-shrink: 0; margin-left: 10px; }
        .text-green { color: var(--accent-green); } .text-yellow { color: var(--accent-yellow); } .text-red { color: var(--accent-red); } .text-blue { color: var(--accent-blue); }
        .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
        .empty-state i { font-size: 3em; color: var(--accent-purple); margin-bottom: 15px; }
        @media (max-width: 768px) {
            #dashboardContent { gap: 20px; }
            .stats-hero-section, .charts-section { grid-template-columns: 1fr; }
            .chart-card { height: 320px; }
            .chart-card canvas { max-height: calc(100% - 50px) !important; height: auto !important; }
            .summary-grid { grid-template-columns: 1fr 1fr; gap: 15px; }
            .translator-item { flex-direction: column; text-align: center; gap: 10px; }
            .translator-info { margin: 10px 0; }
            .detailed-stats-grid { grid-template-columns: 1fr; padding: 15px; }
        }
        @media (max-width: 480px) { .summary-grid { grid-template-columns: 1fr; } }

        #archiveProjectsView { overflow: visible; }
        #archiveProjectsView h2 { margin-bottom: 20px; }
        #archiveCardGrid .project-card { width: 100%; min-width: 0; box-sizing: border-box; } /* Already general */
        .card-placeholder { display: flex; justify-content: center; align-items: center; min-height: 150px; color: var(--text-secondary); font-style: italic; background-color: var(--bg-card-user); padding: 20px; border-radius: 12px; grid-column: 1 / -1; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Member Details Modal Specific Styles */
        #memberDetailsModal .modal-body { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { #memberDetailsModal .modal-body { grid-template-columns: 250px 1fr; } }
        #memberDetailsModal .member-details-main-info { text-align: center; }
        #memberDetailsModal .member-details-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px auto; border: 3px solid var(--border-color); cursor: pointer; }
        #memberDetailsModal .member-details-roles { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 10px; }
        #memberDetailsModal .member-details-social { margin-top: 15px; text-align: center; }
        #memberDetailsModal .member-details-social a { margin: 0 8px; font-size: 1.5em; }
        #memberDetailsModal .member-projects-section h4 { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        #memberDetailsModal .member-project-item { background-color: var(--bg-secondary-user); padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9em; }
        #memberDetailsModal .member-project-item strong { color: var(--accent-purple); }

        /* Project Team Modal Styles */
        #projectTeamModal .team-member-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        #projectTeamModal .team-member-item:last-child { border-bottom: none; }
        #projectTeamModal .team-member-item img { width: 40px; height: 40px; border-radius: 50%; margin-left: 15px; }
        #projectTeamModal .team-member-info h5 { margin: 0 0 5px 0; color: var(--text-main); }
        #projectTeamModal .team-member-info p { margin: 0; font-size: 0.9em; color: var(--text-secondary); }
        #projectTeamModal .team-member-info .role { font-weight: bold; color: var(--accent-blue); }
        #projectTeamModal .team-member-info .payment { color: var(--accent-green); }

        /* Project Details Modal Specific Styles */
        #projectDetailsModal .modal-body { display: grid; grid-template-columns: 1fr; gap: 20px; }
        #projectDetailsModal .project-modal-section { background-color: var(--bg-secondary-user); padding: 15px; border-radius: 8px; }
        #projectDetailsModal .project-modal-section h5 { font-size: 1.1em; color: var(--accent-purple); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        #projectDetailsModal .series-overview-modal { font-size: 0.9em; line-height: 1.6; color: var(--text-secondary); margin-top:10px; }
        @media (min-width: 768px) { #projectDetailsModal .modal-body { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); } }

        /* Settings Page Modern Design */
        .settings-section { background: linear-gradient(135deg, var(--bg-card-user) 0%, rgba(36, 36, 36, 0.8) 100%); padding: 28px 32px; border-radius: 16px; box-shadow: var(--shadow-lg); margin-bottom: 32px; border: 1px solid rgba(139, 92, 246, 0.2); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .settings-section::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(139, 92, 246, 0.05) 0%, transparent 70%); animation: pulse 4s ease-in-out infinite; pointer-events: none; }
        @keyframes pulse { 0%, 100% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 1; } }
        .settings-section:hover { transform: translateY(-2px); box-shadow: var(--shadow-xl); border-color: rgba(139, 92, 246, 0.4); }
        .settings-section h3.section-title { font-size: 1.6em; color: var(--text-main); margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--accent-purple); position: relative; display: flex; align-items: center; gap: 12px; }
        .settings-section h3.section-title::before { content: ''; width: 4px; height: 24px; background: var(--gradient-purple); border-radius: 2px; }
        .settings-section .form-group { margin-bottom: 24px; position: relative; }
        .settings-section .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-main); font-size: 0.95em; transition: color 0.3s ease; }
        .settings-section .form-control { background-color: rgba(74, 85, 104, 0.3); border: 2px solid transparent; transition: all 0.3s ease; backdrop-filter: blur(10px); }
        .settings-section .form-control:hover { background-color: rgba(74, 85, 104, 0.5); border-color: rgba(139, 92, 246, 0.3); }
        .settings-section .form-control:focus { background-color: rgba(74, 85, 104, 0.6); border-color: var(--accent-purple); box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15); }
        .settings-section .toolbar { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; background: transparent; padding: 0; margin-top: 0; box-shadow: none; }
        .settings-section .btn { position: relative; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .settings-section .btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255, 255, 255, 0.2); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        .settings-section .btn:hover::before { width: 300px; height: 300px; }
        .settings-section .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); }
        .settings-section h3.section-title::after { content: ''; font-family: 'Font Awesome 5 Free'; font-weight: 900; margin-right: auto; opacity: 0.3; font-size: 1.2em; }
        #settings > .settings-section:nth-of-type(1) h3.section-title::after { content: '\f200'; } /* chart (reports) */
        #settings > .settings-section:nth-of-type(2) h3.section-title::after { content: '\f0c1'; } /* link (social links) */


        #reportContent { background: rgba(36, 36, 36, 0.6); border: 1px solid rgba(139, 92, 246, 0.2); backdrop-filter: blur(10px); }
        @media print {
            .header, .nav-tabs, .footer, .alert, .modal, .toolbar, .global-actions-container,
            #settings > h2, 
            .settings-section:not(:has(#reportContent)), 
            .settings-section:has(#reportContent) > h3.section-title, 
            .settings-section:has(#reportContent) > .toolbar 
            { display: none !important; }

            @page { size: A4 portrait; margin: 15mm; } 
            body { background: white !important; color: black !important; font-family: 'Arial', 'Tahoma', sans-serif !important; font-size: 10pt !important; line-height: 1.4 !important; direction: rtl !important; margin: 0 !important; padding: 0 !important; }
            
            #appContent { padding: 0 !important; }
            .container { padding: 0 !important; margin: 0 !important; max-width: 100% !important; }
            .tab-content { padding: 0 !important; margin: 0 !important; border: none !important; box-shadow: none !important; }
            #settings.tab-pane.active { display: block !important; } 
            
            #reportContent { 
                display: block !important; visibility: visible !important; 
                background: white !important; color: black !important; 
                border: none !important; box-shadow: none !important; 
                padding: 0 !important; margin: 0 !important; 
                width: 100% !important; max-width: none !important; 
            }
            #reportContent .report-header { background: #f0f0f0 !important; color: black !important; border: 1px solid #333 !important; padding: 10px !important; margin-bottom: 15px !important; page-break-inside: avoid !important; }
            #reportContent .report-header h3 { font-size: 14pt !important; margin: 0 0 8px 0 !important; }
            #reportContent .report-header p { font-size: 9pt !important; margin: 0 !important; }
            #reportContent .report-section { background: white !important; border: 1px solid #ccc !important; padding: 10px !important; margin-bottom: 10px !important; page-break-inside: avoid !important; }
            #reportContent .report-section h4 { font-size: 12pt !important; margin: 0 0 8px 0 !important; border-bottom: 1px solid #666 !important; padding-bottom: 4px !important; }
            #reportContent .report-section ul { padding-right: 20px !important; margin: 0 0 10px 0; font-size: 9pt; }
            #reportContent .report-section li { margin-bottom: 4px; }
            #reportContent .table-container { overflow: visible !important; }
            #reportContent table { width: 100% !important; border-collapse: collapse !important; margin: 10px 0 !important; page-break-inside: auto !important; }
            #reportContent th, #reportContent td { border: 1px solid #666 !important; padding: 5px !important; text-align: right !important; font-size: 9pt !important; word-break: break-word !important; }
            #reportContent th { background-color: #e9e9e9 !important; font-weight: bold; }
            thead { display: table-header-group !important; }
            tfoot { display: table-footer-group !important; }
            tr { page-break-inside: avoid !important; page-break-after: auto !important; }
            a { color: #0066cc !important; text-decoration: none !important; }
            .money-positive { color: #008000 !important; }
            .money-zero { color: #f59e0b !important; }
            .money-negative { color: #cc0000 !important; }
        }
    </style>
</head>
<body>
    <div id="appContent"> 
        <header class="header">
            <div class="header-content">
                <div class="header-social-links">
                    <a href="#" id="headerLinkWebsite" target="_blank" title="الموقع الرسمي"><i class="fas fa-globe"></i></a>
                    <a href="#" id="headerLinkDiscord" target="_blank" title="Discord"><i class="fab fa-discord"></i></a>
                    <a href="#" id="headerLinkTelegram" target="_blank" title="Telegram"><i class="fab fa-telegram-plane"></i></a>
                    <a href="#" id="headerLinkDrive" target="_blank" title="Google Drive"><i class="fab fa-google-drive"></i></a>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab(event, 'dashboard')">لوحة المعلومات</button>
                <button class="nav-tab" onclick="showTab(event, 'members')">الأعضاء</button>
                <button class="nav-tab" onclick="showTab(event, 'projects')">المشاريع</button>
                <button class="nav-tab" onclick="showTab(event, 'settings')">الإعدادات والتقارير</button>
            </div>

            <div class="tab-content">
                <section id="dashboard" class="tab-pane active">
                    <div id="dashboardContent">
                        <div class="stats-hero-section">
                            <div class="card main-stat-card gradient-purple" onclick="navigateToMembersTab()">
                                <div class="stat-icon-wrapper"><i class="fas fa-users"></i></div>
                                <div class="stat-content">
                                    <h2 class="stat-number" id="dbTotalMembers">0</h2>
                                    <p class="stat-label">إجمالي الأعضاء</p>
                                    <div class="stat-details"> <span id="dbActiveMembers">0 نشط</span> | <span id="dbInactiveMembers">0 غير نشط</span> </div>
                                </div>
                            </div>
                            <div class="card main-stat-card gradient-blue" onclick="navigateToProjectsTab()">
                                <div class="stat-icon-wrapper"><i class="fas fa-folder-open"></i></div>
                                <div class="stat-content">
                                    <h2 class="stat-number" id="dbTotalProjects">0</h2>
                                    <p class="stat-label">إجمالي المشاريع</p>
                                    <div class="stat-details"> <span id="dbAnimeCount">0 أنمي</span> | <span id="dbSeriesCount">0 مسلسل</span> </div>
                                </div>
                            </div>
                            <div class="card main-stat-card gradient-green" onclick="navigateToArchiveTab()">
                                <div class="stat-icon-wrapper"><i class="fas fa-check-circle"></i></div>
                                <div class="stat-content">
                                    <h2 class="stat-number" id="dbCompletedProjects">0</h2>
                                    <p class="stat-label">المشاريع المكتملة</p>
                                    <div class="stat-details"> <span id="dbCompletionRate">0%</span> نسبة الإنجاز </div>
                                </div>
                            </div>
                            <div class="card main-stat-card gradient-red" onclick="scrollToFinancialSummaries()">
                                <div class="stat-icon-wrapper"><i class="fas fa-tasks"></i></div>
                                <div class="stat-content">
                                    <h2 class="stat-number" id="dbTotalEpisodes">0</h2>
                                    <p class="stat-label">إجمالي الحلقات المنجزة</p>
                                    <div class="stat-details"> <span id="dbAvgEpisodesPerProject">0</span> متوسط/مشروع </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="charts-section">
                            <div class="card chart-card"> <h3><i class="fas fa-chart-line"></i> نشاط الفريق (آخر 30 يوم)</h3> <canvas id="activityChart"></canvas> </div>
                            <div class="card chart-card"> <h3><i class="fas fa-chart-pie"></i> توزيع المشاريع حسب الحالة</h3> <canvas id="projectStatusChart"></canvas> </div>
                            <div class="card chart-card"> <h3><i class="fas fa-dollar-sign"></i> المدفوعات الشهرية</h3> <canvas id="monthlyPaymentsChart"></canvas> </div>
                        </div>

                        <div id="recentActivitySection">
                            <h3 class="section-header"><i class="fas fa-history"></i> سجل آخر التعديلات</h3>
                            <div class="card">
                                <ul id="recentActivityList">
                                    <li class="text-center text-muted">لا يوجد نشاط حديث.</li>
                                </ul>
                            </div>
                        </div>
                
                        <div class="financial-summaries-section" id="financialSummariesSectionContainer">
                            <h3 class="section-header"><i class="fas fa-money-bill-wave"></i> الملخصات المالية</h3>
                            <div class="card financial-summary-card total-summary">
                                <div class="summary-header"> <h4><i class="fas fa-chart-bar"></i> الملخص المالي الإجمالي</h4> <span class="summary-badge">كل المشاريع</span> </div>
                                <div class="summary-grid">
                                    <div class="summary-item"> <label>إجمالي التكلفة</label> <span class="amount" id="totalProjectsCost">$0.00</span> </div>
                                    <div class="summary-item"> <label>المدفوع للأعضاء</label> <span class="amount" id="totalPaidAmount">$0.00</span> </div>
                                    <div class="summary-item"> <label>المستحقات المتبقية</label> <span class="amount" id="totalRemainingAmount">$0.00</span> </div>
                                    <div class="summary-item"> <label>متوسط التكلفة/حلقة</label> <span class="amount" id="avgCostPerEpisodeTotal">$0.00</span> </div>
                                </div>
                            </div>
                            <div class="card financial-summary-card anime-summary">
                                <div class="summary-header"> <h4><i class="fas fa-tv"></i> الملخص المالي للأنميات</h4> <span class="summary-badge anime">أنمي</span> </div>
                                <div class="summary-grid">
                                    <div class="summary-item"> <label>عدد الأنميات</label> <span class="value" id="animeProjectCount">0</span> </div>
                                    <div class="summary-item"> <label>الحلقات المنجزة</label> <span class="value" id="animeCompletedEpisodes">0</span> </div>
                                    <div class="summary-item"> <label>إجمالي التكلفة</label> <span class="amount" id="animeTotalCost">$0.00</span> </div>
                                    <div class="summary-item"> <label>متوسط التكلفة/حلقة</label> <span class="amount" id="animeAvgCostPerEpisode">$0.00</span> </div>
                                </div>
                            </div>
                            <div class="card financial-summary-card series-summary">
                                <div class="summary-header"> <h4><i class="fas fa-film"></i> الملخص المالي للمسلسلات</h4> <span class="summary-badge series">مسلسل</span> </div>
                                <div class="summary-grid">
                                    <div class="summary-item"> <label>عدد المسلسلات</label> <span class="value" id="seriesProjectCount">0</span> </div>
                                    <div class="summary-item"> <label>الحلقات المنجزة</label> <span class="value" id="seriesCompletedEpisodes">0</span> </div>
                                    <div class="summary-item"> <label>إجمالي التكلفة</label> <span class="amount" id="seriesTotalCost">$0.00</span> </div>
                                    <div class="summary-item"> <label>متوسط التكلفة/حلقة</label> <span class="amount" id="seriesAvgCostPerEpisode">$0.00</span> </div>
                                </div>
                            </div>
                        </div>
                
                        <div class="detailed-stats-section">
                            <h3 class="section-header"><i class="fas fa-chart-area"></i> إحصائيات تفصيلية</h3>
                            <div class="card"> <div class="detailed-stats-grid" id="detailedStatsContainer"> <div class="spinner"></div> </div> </div>
                        </div>
                    </div>
                </section>

                <section id="members" class="tab-pane">
                    <div class="toolbar">
                        <div class="flex gap-10 flex-wrap">
                            <button class="btn btn-primary" onclick="showEntityModal('member')"> <i class="fas fa-user-plus"></i> إضافة عضو </button>
                            <button class="btn btn-danger" onclick="deleteSelected('members')"> <i class="fas fa-trash-alt"></i> حذف المحدد </button>
                        </div>
                        <div class="flex gap-10 flex-wrap">
                             <select id="memberSortSelect" class="form-control" onchange="sortAndLoadData('members', this.value)">
                                <option value="name_asc" selected>الاسم (أ-ي)</option> <option value="name_desc">الاسم (ي-أ)</option>
                                <option value="lastDelivery_desc">آخر نشاط (الأحدث)</option> <option value="lastDelivery_asc">آخر نشاط (الأقدم)</option>
                                <option value="totalProjectEpisodes_desc">إجمالي الحلقات (الأكثر)</option> <option value="totalProjectEpisodes_asc">إجمالي الحلقات (الأقل)</option>
                                <option value="remainingAmount_desc">المبلغ المتبقي (الأكثر)</option> <option value="remainingAmount_asc">المبلغ المتبقي (الأقل)</option>
                            </select>
                        </div>
                    </div>
                    <div class="toolbar" style="justify-content: flex-start;"> <label for="selectAllMembersCard" style="display: flex; align-items: center; gap: 8px; cursor:pointer;"> <input type="checkbox" id="selectAllMembersCard" onchange="toggleSelectAllCards('members')"> <span>تحديد الكل</span> </label> </div>
                    <div id="membersCardGrid" class="cards-grid"> <div class="card-placeholder">جاري تحميل الأعضاء...</div> </div>
                </section>

                <section id="projects" class="tab-pane">
                    <div class="sub-nav-tabs">
                        <button class="sub-nav-tab active" onclick="showProjectSubView('animeProjectsView', this)">الأنميات</button>
                        <button class="sub-nav-tab" onclick="showProjectSubView('seriesProjectsView', this)">المسلسلات</button>
                        <button class="sub-nav-tab" onclick="showProjectSubView('archiveProjectsView', this)">الأرشيف</button>
                    </div>

                    <div id="animeProjectsView" class="project-sub-view active">
                        <div class="toolbar">
                            <div class="flex gap-10 flex-wrap">
                                <button class="btn btn-primary" onclick="showEntityModal('anime')"><i class="fas fa-plus"></i> إضافة أنمي</button>
                                <button class="btn btn-danger" onclick="deleteSelected('anime')"><i class="fas fa-trash"></i> حذف المحدد</button>
                            </div>
                            <div class="flex gap-10 flex-wrap">
                                <select id="animeSortSelect" class="form-control" onchange="sortAndLoadData('anime', this.value)">
                                    <option value="name_asc" selected>الاسم (أ-ي)</option> <option value="name_desc">الاسم (ي-أ)</option>
                                    <option value="totalEpisodes_desc">عدد الحلقات (الأكثر)</option> <option value="totalEpisodes_asc">عدد الحلقات (الأقل)</option>
                                    <option value="premiered_desc">تاريخ العرض (الأحدث)</option> <option value="premiered_asc">تاريخ العرض (الأقدم)</option>
                                    <option value="status">الحالة</option> <option value="duration_desc">مدة الحلقة (الأطول)</option> <option value="duration_asc">مدة الحلقة (الأقصر)</option> 
                                </select>
                                <select id="animeStatusFilter" class="form-control" style="width: 200px;" onchange="filterProjects('anime', this.value)">
                                    <option value="">جميع الحالات (النشطة)</option> <option value="جارٍ">جارٍ</option><option value="قريباً">قريباً</option><option value="متوقف">متوقف</option>
                                </select>
                            </div>
                        </div>
                         <div class="toolbar" style="justify-content: flex-start;"> <label for="selectAllAnimeCard" style="display: flex; align-items: center; gap: 8px; cursor:pointer;"> <input type="checkbox" id="selectAllAnimeCard" onchange="toggleSelectAllCards('anime')"> <span>تحديد الكل</span> </label> </div>
                        <div id="animeCardGrid" class="projects-grid"> <div class="card-placeholder" id="animeCardPlaceholder">لا توجد أنميات لعرضها.</div> </div>
                    </div>

                    <div id="seriesProjectsView" class="project-sub-view">
                        <div class="toolbar">
                            <div class="flex gap-10 flex-wrap">
                                <button class="btn btn-primary" onclick="showEntityModal('series')"><i class="fas fa-plus"></i> إضافة مسلسل</button>
                                <button class="btn btn-danger" onclick="deleteSelected('series')"><i class="fas fa-trash"></i> حذف المحدد</button>
                            </div>
                            <div class="flex gap-10 flex-wrap">
                                 <select id="seriesSortSelect" class="form-control" onchange="sortAndLoadData('series', this.value)">
                                    <option value="name_asc" selected>الاسم (أ-ي)</option> <option value="name_desc">الاسم (ي-أ)</option>
                                    <option value="totalEpisodes_desc">عدد الحلقات (الأكثر)</option> <option value="totalEpisodes_asc">عدد الحلقات (الأقل)</option>
                                    <option value="seriesYear_desc">سنة الإنتاج (الأحدث)</option> <option value="seriesYear_asc">سنة الإنتاج (الأقدم)</option>
                                    <option value="status">الحالة</option> <option value="duration_desc">مدة الحلقة (الأطول)</option> <option value="duration_asc">مدة الحلقة (الأقصر)</option> 
                                </select>
                                <select id="seriesStatusFilter" class="form-control" style="width: 200px;" onchange="filterProjects('series', this.value)">
                                    <option value="">جميع الحالات (النشطة)</option> <option value="جارٍ">جارٍ</option><option value="قريباً">قريباً</option><option value="متوقف">متوقف</option>
                                </select>
                            </div>
                        </div>
                        <div class="toolbar" style="justify-content: flex-start;"> <label for="selectAllSeriesCard" style="display: flex; align-items: center; gap: 8px; cursor:pointer;"> <input type="checkbox" id="selectAllSeriesCard" onchange="toggleSelectAllCards('series')"> <span>تحديد الكل</span> </label> </div>
                         <div id="seriesCardGrid" class="projects-grid"> <div class="card-placeholder" id="seriesCardPlaceholder">لا توجد مسلسلات لعرضها.</div> </div>
                    </div>

                    <div id="archiveProjectsView" class="project-sub-view">
                        <h2>أرشيف المشاريع المكتملة</h2>
                         <div class="toolbar">
                            <div class="flex gap-10 flex-wrap"></div>
                            <div class="flex gap-10 flex-wrap">
                                <select id="archiveTypeFilter" class="form-control" onchange="loadArchivedProjects(this.value)">
                                    <option value="all">جميع الأنواع</option> <option value="anime">أنمي فقط</option> <option value="series">مسلسلات فقط</option>
                                </select>
                                <select id="archiveSortSelect" class="form-control" onchange="sortAndLoadData('archive', this.value)">
                                    <option value="completionDate_desc" selected>تاريخ الإكمال (الأحدث)</option> <option value="completionDate_asc">تاريخ الإكمال (الأقدم)</option>
                                    <option value="name_asc">الاسم (أ-ي)</option> <option value="name_desc">الاسم (ي-أ)</option>
                                    <option value="totalEpisodes_desc">عدد الحلقات (الأكثر)</option> <option value="totalEpisodes_asc">عدد الحلقات (الأقل)</option>
                                    <option value="duration_desc">مدة الحلقة (الأطول)</option> <option value="duration_asc">مدة الحلقة (الأقصر)</option>
                                </select>
                            </div>
                        </div>
                        <div id="archiveCardGrid" class="projects-grid"> <div class="card-placeholder" id="archiveCardPlaceholder">لا توجد مشاريع مكتملة في الأرشيف حالياً.</div> </div>
                    </div>
                </section>

                <section id="settings" class="tab-pane">
                    <h2>الإعدادات والتقارير</h2>
                    <section class="settings-section">
                        <h3 class="section-title">التقارير</h3>
                        <div class="toolbar flex-wrap gap-10">
                            <button class="btn btn-primary" onclick="generateReport('monthly')"><i class="fas fa-chart-line"></i> تقرير شهري</button>
                            <button class="btn btn-primary" onclick="generateReport('projects')"><i class="fas fa-clipboard-list"></i> تقرير المشاريع</button>
                            <div class="flex gap-10">
                                <select id="reportMemberSelect" class="form-control" style="min-width: 250px;"> <option value="">اختر عضواً لتقرير مفصل...</option> </select>
                                <button class="btn btn-primary" onclick="generateReport('memberDetailed')"><i class="fas fa-user-tag"></i> تقرير عضو مفصل</button>
                            </div>
                            <button class="btn btn-success" onclick="printReport()"><i class="fas fa-print"></i> طباعة التقرير</button>
                            <button class="btn btn-warning" onclick="saveReportAsHTML()"><i class="fas fa-save"></i> حفظ كـ HTML</button>
                        </div>
                        <div id="reportContent" class="mt-20 card"> <p class="text-center text-muted">اختر نوع التقرير لعرضه.</p> </div>
                    </section>
                    
                    <section class="settings-section">
                        <h3 class="section-title">تعيين الروابط</h3>
                        <div class="form-group"> <label for="headerLogoUrl">رابط صورة الهيدر (للخلفية الكاملة، اختياري)</label> <input type="url" class="form-control" id="headerLogoUrl" placeholder="https://example.com/logo.png" onchange="updateSettings()"> </div>
                        <div class="form-group"> <label for="headerLinkWebsiteUrl">رابط الموقع الرسمي</label> <input type="url" class="form-control" id="headerLinkWebsiteUrl" placeholder="https://example.com" onchange="updateSettings()"> </div>
                        <div class="form-group"> <label for="headerLinkDiscordUrl">رابط ديسكورد</label> <input type="url" class="form-control" id="headerLinkDiscordUrl" placeholder="https://discord.gg/xxxx" onchange="updateSettings()"> </div>
                        <div class="form-group"> <label for="headerLinkTelegramUrl">رابط تيليجرام</label> <input type="url" class="form-control" id="headerLinkTelegramUrl" placeholder="https://t.me/xxxx" onchange="updateSettings()"> </div>
                        <div class="form-group"> <label for="headerLinkDriveUrl">رابط جوجل درايف</label> <input type="url" class="form-control" id="headerLinkDriveUrl" placeholder="https://drive.google.com/xxxx" onchange="updateSettings()"> </div>
                    </section>
                </section>
            </div>
        </div>
        <footer class="footer"> <div class="brand">ReviveSubs</div> <p>جميع البيانات محفوظة محلياً في المتصفح (IndexedDB)</p> </footer>
    </div>

    <!-- Global Actions Toolbar -->
    <div class="global-actions-container">
        <input type="text" id="globalSearchInput" class="search-box hidden" placeholder="بحث عام..." onkeyup="debouncedGlobalSearch()">
        <button id="globalSearchToggleBtn" class="btn-icon" title="بحث عام"><i class="fas fa-search"></i></button>
        <button id="globalSaveBtn" class="btn-icon" title="حفظ البيانات"><i class="fas fa-save"></i></button>

        <div class="dropdown-container">
            <button id="globalImportToggleBtn" class="btn-icon" title="استيراد"><i class="fas fa-file-import"></i></button>
            <div id="globalImportDropdown" class="dropdown-menu hidden">
                <a href="#" onclick="importData(); closeModal('globalImportDropdown');">استيراد محلي</a>
                <a href="#" onclick="listGoogleDriveBackupsForImport()">استيراد سحابي</a>
            </div>
        </div>

        <div class="dropdown-container">
            <button id="globalExportToggleBtn" class="btn-icon" title="تصدير"><i class="fas fa-file-export"></i></button>
            <div id="globalExportDropdown" class="dropdown-menu hidden">
                <a href="#" onclick="exportAllData(); closeModal('globalExportDropdown');">تصدير محلي</a>
                <a href="#" onclick="uploadToGoogleDriveWithRotation()">تصدير سحابي</a>
            </div>
        </div>
        <!-- A button to sign in/out of Google could be added here if desired for more explicit control -->
        <!-- <button id="googleSignInBtn" class="btn-icon hidden" title="تسجيل الدخول Google"><i class="fab fa-google"></i></button> -->
    </div>


    <!-- Combined Member/Project Modal -->
    <div id="entityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="entityModalTitle"></h2><span class="close" onclick="closeModal('entityModal')">×</span></div>
            <div class="modal-body">
                <form id="entityForm" onsubmit="event.preventDefault(); saveEntity();">
                    <input type="hidden" id="entityId" value="">
                    <input type="hidden" id="entityType" value="">

                    <!-- Common Fields -->
                    <div class="form-group"><label id="entityNameLabel" for="entityName">الاسم *</label><input type="text" class="form-control" id="entityName" required></div>

                    <!-- Member Specific Fields -->
                    <div id="memberSpecificFields" class="hidden">
                        <div class="form-group"><label for="memberAvatarUrl">رابط صورة العضو (Avatar URL)</label><input type="url" class="form-control" id="memberAvatarUrl" placeholder="https://example.com/avatar.png"></div>
                        <div class="form-group"><label>الأدوار *</label><div class="flex gap-20 flex-wrap"><label><input type="checkbox" id="roleTranslator" value="translator"> مترجم</label><label><input type="checkbox" id="roleEditor" value="editor"> مدقق</label><label><input type="checkbox" id="roleTimer" value="timer"> محاكي</label><label><input type="checkbox" id="roleSubtitler" value="subtitler"> موقت</label></div></div>
                        <div class="form-group"><label for="amountReceived">المبلغ المستلم</label><input type="number" class="form-control" id="amountReceived" value="0" min="0" step="0.01"></div>
                        <div class="form-group"><label for="paymentMethod">طريقة الدفع</label><input type="text" class="form-control" id="paymentMethod" placeholder="مثال: PayPal, بنك محلي, Binance"></div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="form-group"><label for="twitterHandle">حساب X (Twitter)</label><input type="text" class="form-control" id="twitterHandle" placeholder="@username أو رابط"></div>
                            <div class="form-group"><label for="discordHandle">حساب ديسكورد</label><input type="text" class="form-control" id="discordHandle" placeholder="username#0000"></div>
                            <div class="form-group"><label for="telegramHandle">حساب تيليجرام</label><input type="text" class="form-control" id="telegramHandle" placeholder="@username أو رابط"></div>
                        </div>
                        <div class="form-group"><label for="blog">المدونة/الموقع</label><input type="url" class="form-control" id="blog" placeholder="https://example.com"></div>
                        <div class="form-group"><label for="memberNotes">ملاحظات</label><textarea class="form-control" id="memberNotes" rows="3"></textarea></div>
                    </div>

                    <!-- Project Specific Fields -->
                    <div id="projectSpecificFields" class="hidden">
                        <div id="malFieldsContainer" class="hidden">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group"> <label for="projectMalId">معرف MAL</label> <input type="text" class="form-control" id="projectMalId" placeholder="مثال: 5114"> </div>
                                <div class="form-group"> <label for="projectUrl">رابط MAL</label> <input type="url" class="form-control" id="projectUrl" placeholder="https://myanimelist.net/anime/..."> </div>
                            </div>
                            <button type="button" class="btn btn-info btn-sm mb-10" id="fetchMalDataBtn" onclick="fetchExternalData('anime')"><i class="fas fa-sync-alt"></i> جلب بيانات من MAL</button>
                            <span id="malFetchLoader" class="ai-loading-indicator hidden">جاري جلب البيانات...</span>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="form-group"> <label for="projectAnimeType">نوع الأنمي</label> <input type="text" class="form-control" id="projectAnimeType"> </div>
                                <div class="form-group"> <label for="projectStudio">الاستوديو</label> <input type="text" class="form-control" id="projectStudio"> </div>
                                <div class="form-group"> <label for="projectSource">مصدر الاقتباس</label> <input type="text" class="form-control" id="projectSource"> </div>
                                <div class="form-group"> <label for="projectPremiered">تاريخ أول عرض</label> <input type="text" class="form-control" id="projectPremiered"> </div>
                                <div class="form-group"> <label for="projectDuration">مدة الحلقة</label> <input type="text" class="form-control" id="projectDuration"> </div>
                                <div class="form-group"> <label for="projectRating">التصنيف العمري</label> <input type="text" class="form-control" id="projectRating"> </div>
                                <div class="form-group"> <label for="projectScore">التقييم (Score)</label> <input type="text" class="form-control" id="projectScore"> </div>
                            </div>
                            <div class="form-group"> <label for="projectGenres">التصنيفات (Genres)</label> <input type="text" class="form-control" id="projectGenres" placeholder="مثال: Action, Comedy"> </div>
                            <div class="form-group"> <label for="projectThemes">المواضيع (Themes)</label> <input type="text" class="form-control" id="projectThemes" placeholder="مثال: Super Power, Mecha"> </div>
                            <div class="form-group"> <label for="projectImageUrl">رابط الصورة</label> <input type="url" class="form-control" id="projectImageUrl"> </div>
                        </div>
                        <div id="tvdbFieldsContainer" class="hidden">
                            <div class="form-group"> <label for="projectSeriesNameSearch">اسم المسلسل للبحث في TMDB</label> <input type="text" class="form-control" id="projectSeriesNameSearch" placeholder="أدخل اسم المسلسل هنا للبحث..."> </div>
                            <button type="button" class="btn btn-info btn-sm mb-10" id="fetchTmdbDataBtn" onclick="fetchExternalData('series')"><i class="fas fa-sync-alt"></i> جلب بيانات من TMDB</button>
                            <span id="tmdbFetchLoader" class="ai-loading-indicator hidden">جاري جلب البيانات...</span>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="form-group"> <label for="projectTmdbUrl">رابط TMDB</label> <input type="url" class="form-control" id="projectTmdbUrl" placeholder="https://www.themoviedb.org/tv/..."> </div>
                                <div class="form-group"> <label for="projectSeriesYear">سنة أول عرض</label> <input type="text" class="form-control" id="projectSeriesYear" placeholder="مثال: 2023"> </div>
                                <div class="form-group"> <label for="projectSeriesNetwork">الشبكة</label> <input type="text" class="form-control" id="projectSeriesNetwork" placeholder="مثال: Netflix, HBO"> </div>
                                <div class="form-group"> <label for="projectSeriesStatusTMDB">حالة المسلسل (TMDB)</label> <input type="text" class="form-control" id="projectSeriesStatusTMDB" placeholder="مثال: Continuing, Ended"> </div>
                                <div class="form-group"> <label for="projectSeriesEpisodeRunTime">مدة الحلقة (دقائق)</label> <input type="text" class="form-control" id="projectSeriesEpisodeRunTime" placeholder="مثال: 45, 22-25"> </div>
                                <div class="form-group"> <label for="projectSeriesGenres">التصنيفات</label> <input type="text" class="form-control" id="projectSeriesGenres"> </div>
                                <div class="form-group"> <label for="projectSeriesVoteAverage">متوسط التقييم (TMDB)</label> <input type="text" class="form-control" id="projectSeriesVoteAverage"> </div>
                                <div class="form-group"> <label for="projectSeriesPosterUrl">رابط البوستر</label> <input type="url" class="form-control" id="projectSeriesPosterUrl"> </div>
                                <div class="form-group"> <label for="projectSeriesOriginCountry">بلد المنتج</label> <input type="text" class="form-control" id="projectSeriesOriginCountry"> </div>
                                <div class="form-group"> <label for="projectSeriesOriginalLanguage">اللغة الأصلية</label> <input type="text" class="form-control" id="projectSeriesOriginalLanguage"> </div>
                            </div>
                            <div class="form-group"> <label for="projectSeriesOverview">نبذة قصيرة</label> <textarea class="form-control" id="projectSeriesOverview" rows="2"></textarea> </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group"><label for="projectStatus">حالة المشروع (في فريقك) *</label><select class="form-control" id="projectStatus" required><option value="">اختر الحالة</option><option value="مكتمل">مكتمل</option><option value="جارٍ">جارٍ</option><option value="قريباً">قريباً</option><option value="متوقف">متوقف</option></select></div>
                            <div class="form-group"><label for="totalEpisodes">عدد الحلقات الكلي</label><input type="number" class="form-control" id="totalEpisodes" value="0" min="0"></div>
                        </div>
                        <div class="form-group"><label for="completedEpisodesProject">الحلقات المنتهية (في المشروع)</label><input type="number" class="form-control" id="completedEpisodesProject" value="0" min="0"></div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="form-group"> <label for="projectTranslator">المترجم</label> <select class="form-control" id="projectTranslator"><option value="">اختر المترجم</option></select> <label for="translationPrice" class="mt-10">سعر الترجمة/حلقة</label> <input type="number" class="form-control" id="translationPrice" value="0" min="0" step="0.5"> <label for="translationBonus" class="mt-10">أجرة إضافية/مخصومة للمترجم (إجمالي)</label> <input type="number" class="form-control" id="translationBonus" value="0" step="0.01" placeholder="موجب للإضافة، سالب للخصم"> </div>
                            <div class="form-group"> <label for="projectEditor">المدقق</label> <select class="form-control" id="projectEditor"><option value="">اختر المدقق</option></select> <label for="editingPrice" class="mt-10">سعر التدقيق/حلقة</label> <input type="number" class="form-control" id="editingPrice" value="0" min="0" step="0.5"> <label for="editingBonus" class="mt-10">أجرة إضافية/مخصومة للمدقق (إجمالي)</label> <input type="number" class="form-control" id="editingBonus" value="0" step="0.01" placeholder="موجب للإضافة، سالب للخصم"> </div>
                            <div class="form-group"> <label for="projectTimer">المحاكي</label> <select class="form-control" id="projectTimer"><option value="">اختر المحاكي</option></select> <label for="timerPrice" class="mt-10">سعر المحاكاة/حلقة</label> <input type="number" class="form-control" id="timerPrice" value="0" min="0" step="0.5"> <label for="timerBonus" class="mt-10">أجرة إضافية/مخصومة للمحاكي (إجمالي)</label> <input type="number" class="form-control" id="timerBonus" value="0" step="0.01" placeholder="موجب للإضافة، سالب للخصم"> </div>
                            <div class="form-group"> <label for="projectSubtitler">الموقت</label> <select class="form-control" id="projectSubtitler"><option value="">اختر الموقت</option></select> <label for="subtitlerPrice" class="mt-10">سعر التوقيت/حلقة</label> <input type="number" class="form-control" id="subtitlerPrice" value="0" min="0" step="0.5"> <label for="subtitlerBonus" class="mt-10">أجرة إضافية/مخصومة للموقت (إجمالي)</label> <input type="number" class="form-control" id="subtitlerBonus" value="0" step="0.01" placeholder="موجب للإضافة، سالب للخصم"> </div>
                        </div>
                        <div class="form-group"><label for="rawUrl">رابط الملفات الخام</label><input type="url" class="form-control" id="rawUrl" placeholder="https://..."></div>
                        <div class="form-group"> <label for="projectNotes">ملاحظات</label> <textarea class="form-control" id="projectNotes" rows="3"></textarea> </div>
                    </div>
                     <div class="modal-footer"><button type="submit" class="btn btn-primary">حفظ</button><button type="button" class="btn btn-secondary" onclick="closeModal('entityModal')">إلغاء</button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="memberDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;"> <div class="modal-header"> <h2 id="memberDetailsModalTitle">تفاصيل العضو</h2> <span class="close" onclick="closeModal('memberDetailsModal')">×</span> </div>
            <div class="modal-body">
                <div class="member-details-main-info">
                    <img id="memberDetailsAvatar" src="" class="member-details-avatar" alt="Avatar">
                    <h3 id="memberDetailsName" style="font-size: 1.5em; margin-bottom: 5px;"></h3>
                    <div id="memberDetailsRoles" class="member-details-roles"></div>
                    <div id="memberDetailsSocial" class="member-details-social"></div>
                    <div class="mt-20"> <h4>طريقة الدفع:</h4> <p id="memberDetailsPaymentMethod" class="text-sm text-muted"></p> </div>
                    <div class="mt-20"> <h4>ملاحظات:</h4> <p id="memberDetailsNotes" class="text-sm text-muted" style="white-space: pre-wrap;"></p> </div>
                </div>
                <div class="member-projects-section"> <h4>المشاريع التي عمل عليها</h4> <div id="memberDetailsProjectsList" style="max-height: 40vh; overflow-y: auto;"></div> </div>
            </div>
            <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="closeModal('memberDetailsModal')">إغلاق</button> </div>
        </div>
    </div>

    <div id="tmdbResultsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"> <h2>نتائج البحث في TMDB</h2> <span class="close" onclick="closeModal('tmdbResultsModal')">×</span> </div>
            <div class="modal-body"> <p>اختر المسلسل الصحيح من القائمة:</p> <ul id="tmdbResultsList"></ul> </div>
            <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="closeModal('tmdbResultsModal')">إلغاء</button> </div>
        </div>
    </div>

    <div id="imagePreviewModal" class="modal" onclick="this.style.display='none'"> <span class="close-preview" onclick="closeModal('imagePreviewModal')">×</span> <img id="previewImage" src="" alt="معاينة الصورة"> </div>

    <div id="projectTeamModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header"> <h2 id="projectTeamModalTitle">فريق عمل المشروع</h2> <span class="close" onclick="closeModal('projectTeamModal')">×</span> </div>
            <div class="modal-body" id="projectTeamModalBody"> <p class="text-center text-muted">جاري تحميل تفاصيل الفريق...</p> </div>
            <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="closeModal('projectTeamModal')">إغلاق</button> </div>
        </div>
    </div>

    <div id="projectDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header"> <h2 id="projectDetailsModalTitle">تفاصيل المشروع</h2> <span class="close" onclick="closeModal('projectDetailsModal')">×</span> </div>
            <div class="modal-body" id="projectDetailsModalBody"></div>
             <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="closeModal('projectDetailsModal')">إغلاق</button> </div>
        </div>
    </div>

    <div id="googleDriveBackupsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>اختر نسخة احتياطية للاستيراد من Google Drive</h2>
                <span class="close" onclick="closeModal('googleDriveBackupsModal')">×</span>
            </div>
            <div class="modal-body" id="googleDriveBackupsListContainer" style="max-height: 60vh; overflow-y: auto;">
                <div class="spinner"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('googleDriveBackupsModal')">إلغاء</button>
            </div>
        </div>
    </div>


    <template id="memberCardTemplate">
        <article class="member-card card"> <div class="card-header member-card-header"> <img src="" class="member-avatar" alt="Avatar" onerror="this.src='https://placehold.co/60x60/718096/e5e7eb?text=X'; this.onerror=null;">
                <div class="member-info"> <h3></h3> <div class="member-roles"></div> </div>
                <div class="card-actions"> <input type="checkbox" class="member-checkbox" title="تحديد العضو"> </div>
            </div>
            <div class="card-stats">
                <div class="stat-item"> <span class="stat-label">الحلقات</span> <span class="stat-value episodes">0</span> </div>
                <div class="stat-item"> <span class="stat-label">المستحقات</span> <span class="stat-value dues">$0.00</span> </div>
                <div class="stat-item"> <span class="stat-label">آخر نشاط</span> <span class="stat-value last-activity">غير معروف</span> </div>
            </div>
            <div class="card-footer">
                <button class="btn-text edit-btn"><i class="fas fa-edit"></i> تعديل</button>
                <button class="btn-text view-details-btn"><i class="fas fa-eye"></i> عرض التفاصيل</button>
                <div class="social-links"></div>
            </div>
        </article>
    </template>

    <template id="projectCardTemplate">
        <article class="project-card card">
            <div class="project-header card-header">
                 <div class="project-poster"> <img src="" alt="Poster" onerror="this.src='https://placehold.co/100x140/242424/b0b0b0?text=Error'; this.onerror=null;"> <div class="project-type-badge"></div> </div>
                <div class="project-main-info"> <h3 class="project-title"></h3> <div class="project-meta"></div> <div class="project-genres"></div> </div>
                <div class="project-status-widget">
                    <div class="status-indicator"></div>
                    <div class="circular-progress">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                            <path class="circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                        </svg>
                        <div class="progress-text"> <span class="completed">0</span> <span class="separator">/</span> <span class="total">?</span> </div>
                    </div>
                    <p class="progress-label">0% مكتمل</p>
                </div>
            </div>
            <div class="project-team">
                <h4><i class="fas fa-users"></i> فريق العمل</h4>
                <div class="project-team-avatars">
                    <button class="btn btn-sm btn-secondary btn-team-details"> <i class="fas fa-users"></i> عرض الفريق </button>
                    <button class="btn btn-sm btn-info project-cost-calculator-btn" title="حاسبة التكاليف"><i class="fas fa-calculator"></i></button>
                    <div class="avatar-group"></div>
                </div>
                <div class="project-cost-details-popup hidden">
                    <button class="close-cost-popup">&times;</button>
                    <h4>تفاصيل التكلفة</h4>
                    <div class="cost-popup-content"></div>
                </div>
            </div>
            <div class="project-actions">
                <button class="action-btn primary edit-btn"><i class="fas fa-edit"></i> تعديل</button>
                <button class="action-btn project-card-details-btn"><i class="fas fa-info-circle"></i> عرض التفاصيل</button>
                <button class="action-btn secondary files-btn"><i class="fas fa-link"></i> الملفات</button>
                <a href="#" target="_blank" class="project-card-link-btn mal-link hidden" title="صفحة المشروع على MyAnimeList"><i class="fas fa-external-link-alt"></i> MAL</a>
                <a href="#" target="_blank" class="project-card-link-btn tmdb-link hidden" title="صفحة المشروع على TMDB"><i class="fas fa-film"></i> TMDB</a>
                <button class="action-btn danger archive-btn" style="margin-right: auto;"><i class="fas fa-archive"></i> أرشفة</button>
                 <input type="checkbox" class="project-card-checkbox" style="margin-left:10px; width:20px; height:20px; cursor:pointer;" title="تحديد المشروع">
            </div>
        </article>
    </template>

    <script>
        // ========== UTILITIES ==========
        function debounce(func, delay) { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; }
        function isValidUrl(string) { try { new URL(string); return true; } catch (_) { return false; } }
        function isValidSocialHandle(handle, pattern) { return pattern.test(handle) || isValidUrl(handle); }
        const twitterPattern = /^@?[a-zA-Z0-9_]{1,15}$/;
        const telegramPattern = /^@?[a-zA-Z0-9_]{5,32}$/;

        // ========== DOM HELPER FUNCTIONS ==========
        function getEl(id) { return document.getElementById(id); }
        function getVal(id) { const el = getEl(id); return el ? el.value.trim() : ''; }
        function setVal(id, value) { const el = getEl(id); if (el) el.value = value || ''; }
        
        function toggleVisibility(id, show, useActiveClass = false) { 
            const el = getEl(id); 
            if (el) {
                if (useActiveClass) {
                    if (show) el.classList.add('active');
                    else el.classList.remove('active');
                } else {
                    el.classList.toggle('hidden', !show);
                }
            }
        }

        function setChecked(id, checked) { const el = getEl(id); if (el) el.checked = checked; }
        function isChecked(id) { const el = getEl(id); return el ? el.checked : false; }
        function setHTML(id, html) { const el = getEl(id); if (el) el.innerHTML = html; }
        function setText(id, text) { const el = getEl(id); if (el) el.textContent = text; }
        function setDisabled(id, disabled) { const el = getEl(id); if (el) el.disabled = disabled; }
        function setStyle(id, property, value) { const el = getEl(id); if (el) el.style[property] = value; }
        function addClass(id, className) { const el = getEl(id); if (el) el.classList.add(className); }
        function removeClass(id, className) { const el = getEl(id); if (el) el.classList.remove(className); }


        // ========== GLOBAL VARIABLES & CONFIG ==========
        const DB_NAME = "ReviveSubsDB", STORE_NAME = "appDataStore", DB_VERSION = 1, MAIN_DATA_KEY = "mainApplicationData";
        let data = { version: "2.9.7" }; // Version will be fully populated

        const PROJECT_BASE_CONFIG = {
            formFields: ['projectStatus', 'totalEpisodes', 'completedEpisodesProject', 'projectTranslator', 'projectEditor', 'projectTimer', 'projectSubtitler', 'translationPrice', 'editingPrice', 'timerPrice', 'subtitlerPrice', 'translationBonus', 'editingBonus', 'timerBonus', 'subtitlerBonus', 'rawUrl', 'projectNotes'],
            numberFields: ['totalEpisodes', 'completedEpisodesProject', 'translationPrice', 'editingPrice', 'timerPrice', 'subtitlerPrice', 'translationBonus', 'editingBonus', 'timerBonus', 'subtitlerBonus'],
            selectFields: ['projectStatus', 'projectTranslator', 'projectEditor', 'projectTimer', 'projectSubtitler']
        };

        const PROJECT_CONFIG = {
            anime: {
                ...PROJECT_BASE_CONFIG, type: 'anime', nameLabel: 'اسم الأنمي', modalTitleAdd: 'إضافة أنمي جديد', modalTitleEdit: 'تعديل بيانات الأنمي',
                fieldsContainerId: 'malFieldsContainer', altFieldsContainerId: 'tvdbFieldsContainer',
                fetchDataFnName: 'fetchExternalData', fetchButtonId: 'fetchMalDataBtn', fetchLoaderId: 'malFetchLoader',
                externalApiFields: ['projectMalId', 'projectUrl', 'projectImageUrl', 'projectAnimeType', 'projectStudio', 'projectSource', 'projectPremiered', 'projectGenres', 'projectThemes', 'projectDuration', 'projectRating', 'projectScore'],
                dataProperties: { malId: 'projectMalId', url: 'projectUrl', imageUrl: 'projectImageUrl', animeType: 'projectAnimeType', studio: 'projectStudio', source: 'projectSource', premiered: 'projectPremiered', genres: 'projectGenres', themes: 'projectThemes', duration: 'projectDuration', rating: 'projectRating', score: 'projectScore'},
                genreProperty: 'genres', posterProperty: 'imageUrl', yearProperty: 'premiered', ratingProperty: 'score', durationProperty: 'duration',
                externalLinkProperty: 'url', externalLinkName: 'MAL', primaryLinkSelector: '.mal-link', secondaryLinkSelector: '.tmdb-link',
                statusFilterId: 'animeStatusFilter', cardGridId: 'animeCardGrid', selectAllCheckboxId: 'selectAllAnimeCard'
            },
            series: {
                ...PROJECT_BASE_CONFIG, type: 'series', nameLabel: 'اسم المسلسل', modalTitleAdd: 'إضافة مسلسل جديد', modalTitleEdit: 'تعديل بيانات المسلسل',
                fieldsContainerId: 'tvdbFieldsContainer', altFieldsContainerId: 'malFieldsContainer',
                fetchDataFnName: 'fetchExternalData', fetchButtonId: 'fetchTmdbDataBtn', fetchLoaderId: 'tmdbFetchLoader',
                externalApiFields: ['projectSeriesNameSearch', 'projectTmdbUrl', 'projectSeriesYear', 'projectSeriesNetwork', 'projectSeriesStatusTMDB', 'projectSeriesOverview', 'projectSeriesGenres', 'projectSeriesVoteAverage', 'projectSeriesPosterUrl', 'projectSeriesOriginCountry', 'projectSeriesOriginalLanguage', 'projectSeriesEpisodeRunTime'],
                dataProperties: { seriesNameSearch:'projectSeriesNameSearch', url: 'projectTmdbUrl', seriesYear: 'projectSeriesYear', seriesNetwork: 'projectSeriesNetwork', seriesStatusTMDB: 'projectSeriesStatusTMDB', seriesOverview: 'projectSeriesOverview', seriesGenres: 'projectSeriesGenres', seriesVoteAverage: 'projectSeriesVoteAverage', seriesPosterUrl: 'projectSeriesPosterUrl', seriesOriginCountry: 'projectSeriesOriginCountry', seriesOriginalLanguage: 'projectSeriesOriginalLanguage', seriesEpisodeRunTime: 'projectSeriesEpisodeRunTime' },
                genreProperty: 'seriesGenres', posterProperty: 'seriesPosterUrl', yearProperty: 'seriesYear', ratingProperty: 'seriesVoteAverage', durationProperty: 'projectSeriesEpisodeRunTime',
                externalLinkProperty: 'url', externalLinkName: 'TMDB', primaryLinkSelector: '.tmdb-link', secondaryLinkSelector: '.mal-link',
                statusFilterId: 'seriesStatusFilter', cardGridId: 'seriesCardGrid', selectAllCheckboxId: 'selectAllSeriesCard'
            }
        };

        let unsavedChanges = false;
        let selectedItems = { members: new Set(), anime: new Set(), series: new Set(), archive: new Set() };
        let currentSort = { members: 'name_asc', anime: 'name_asc', series: 'name_asc', archive: 'completionDate_desc' };
        let chartInstances = {};
        const LAZY_LOAD_BATCH_SIZE = 10;
        let lazyLoadCounters = { members: 0, anime: 0, series: 0, archive: 0 };
        let intersectionObservers = { members: null, anime: null, series: null, archive: null };
        let currentFilteredAndSortedItems = { members: [], anime: [], series: [], archive: [] };
        
        let globalSearchQuery = ""; // For global search
        const debouncedGlobalSearch = debounce(handleGlobalSearch, 300);

        // ========== GOOGLE DRIVE INTEGRATION VARIABLES ==========
        const GOOGLE_CLIENT_ID = '365561915299-to68jo8cnvhvk6is9hgqu0si54n46nub.apps.googleusercontent.com';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file'; // Access to files created by this app
        const APP_FOLDER_NAME = 'ReviveSubs_Backups';
        const MAX_DRIVE_BACKUPS = 3;

        let googleAuth;
        let isGoogleApiLoadedAndInitialized = false;
        let googleApiLoadInitiated = false;


        // ========== DATABASE (IndexedDB) ==========
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => { const db = event.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME); };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => { console.error("IndexedDB error:", event.target.errorCode); reject(event.target.errorCode); };
            });
        }

        async function loadData() {
            try {
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, "readonly");
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(MAIN_DATA_KEY);
                return new Promise((resolve, reject) => {
                    request.onsuccess = async (event) => {
                        const savedData = event.target.result;
                        const defaultStructure = initializeDefaultDataStructure(false);
                        if (savedData) {
                            if (savedData.version !== data.version) console.warn(`Data version mismatch. Current: ${data.version}, Saved: ${savedData.version}. Attempting to merge.`);
                            data = { ...defaultStructure, ...savedData }; 
                            data.settings = { ...defaultStructure.settings, ...(savedData.settings || {}) };
                            data.members = (savedData.members || []); 
                            data.anime = savedData.anime || []; data.series = savedData.series || []; 
                            data.recentActivityLog = savedData.recentActivityLog || []; 
                        } else {
                            data = defaultStructure; await saveData(); 
                        }
                        updateHeaderDisplay(); updateHeaderSocialLinks();
                        unsavedChanges = false; resolve();
                    };
                    request.onerror = (event) => { console.error('Error loading data from IndexedDB:', event.target.errorCode); requestAnimationFrame(() => showAlert('خطأ في تحميل البيانات. سيتم استخدام البيانات الافتراضية.', 'danger')); data = initializeDefaultDataStructure(false); resolve(); };
                });
            } catch (error) { console.error("Failed to open DB for loading:", error); requestAnimationFrame(() => showAlert('فشل فتح قاعدة البيانات. سيتم استخدام البيانات الافتراضية.', 'danger')); data = initializeDefaultDataStructure(false); return Promise.resolve(); }
        }

        function initializeDefaultDataStructure(setGlobal = true) {
            const defaultStructure = {
                version: "2.9.7", lastSaved: new Date().toISOString(),
                settings: { 
                    headerLogoUrl: "", 
                    headerLinkWebsiteUrl: "#", 
                    headerLinkDiscordUrl: "#", 
                    headerLinkTelegramUrl: "#", 
                    headerLinkDriveUrl: "#" 
                },
                members: [], anime: [], series: [], 
                recentActivityLog: [] 
            };
            if (setGlobal) data = JSON.parse(JSON.stringify(defaultStructure));
            return defaultStructure;
        }

        async function saveData() {
            try {
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                data.lastSaved = new Date().toISOString();
                const request = store.put(data, MAIN_DATA_KEY);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => { unsavedChanges = false; console.log('Data saved to IndexedDB successfully.'); resolve(true); };
                    request.onerror = (event) => { console.error('Error saving data to IndexedDB:', event.target.errorCode); requestAnimationFrame(() => showAlert('خطأ أثناء حفظ البيانات في IndexedDB!', 'danger')); reject(false); };
                });
            } catch (error) { console.error("Failed to open DB for saving:", error); requestAnimationFrame(() => showAlert('فشل فتح قاعدة البيانات للحفظ!', 'danger')); return Promise.resolve(false); }
        }
        async function manualSaveData(){ if(await saveData()){ requestAnimationFrame(() => showAlert('تم حفظ البيانات يدوياً بنجاح!', 'success')); logRecentActivity(`تم حفظ جميع البيانات يدوياً.`); } else { unsavedChanges = true; } }


        // ========== CORE APP LOGIC & UI ROUTING ==========
        document.addEventListener('DOMContentLoaded', async function() {
            initializeApp();
            setupDropdowns(); 
            getEl('globalSearchToggleBtn').addEventListener('click', () => {
                getEl('globalSearchInput').classList.toggle('hidden');
                if (!getEl('globalSearchInput').classList.contains('hidden')) {
                    getEl('globalSearchInput').focus();
                }
            });
            getEl('globalSaveBtn').addEventListener('click', manualSaveData);
            // Local import/export buttons are now in dropdowns, event listeners are on the <a> tags.
        });

        async function initializeApp() {
            try { await loadData(); }
            catch (error) { console.error("Error during initial data load:", error); requestAnimationFrame(() => showAlert("حدث خطأ أثناء تحميل البيانات الأولية.", "danger")); data = initializeDefaultDataStructure(false); }
            recalculateAllMemberData(); updateAllDisplays(); populateMemberReportDropdown();
            recalculateAllMemberData();

            const animeStatusFilterEl = getEl(PROJECT_CONFIG.anime.statusFilterId);
            if (animeStatusFilterEl) animeStatusFilterEl.value = 'جارٍ';

            const seriesStatusFilterEl = getEl(PROJECT_CONFIG.series.statusFilterId);
            if (seriesStatusFilterEl) seriesStatusFilterEl.value = 'جارٍ';

            updateAllDisplays(); populateMemberReportDropdown();
            window.addEventListener('beforeunload', (e) => {
                if (unsavedChanges) {
                    requestAnimationFrame(() => showAlert(
                        'تنبيه: لديك تغييرات غير محفوظة. إغلاق الصفحة الآن قد يؤدي إلى فقدان هذه التغييرات.',
                        'warning',
                        7000 // Duration in ms
                    ));
                    const confirmationMessage = 'لديك تغييرات غير محفوظة. هل أنت متأكد أنك تريد المغادرة وفقدان هذه التغييرات؟';
                    e.preventDefault(); 
                    e.returnValue = confirmationMessage; 
                    return confirmationMessage; 
                }
            });
            showProjectSubView('animeProjectsView', document.querySelector('.sub-nav-tab[onclick*="animeProjectsView"]'));
            ['members', 'anime', 'series'].forEach(type => updateDeleteButtonText(type));
        }

        function updateAllDisplays() {
            updateDashboard();
            sortAndLoadData('members', currentSort.members);
            const activeProjectSubViewButton = document.querySelector('#projects .sub-nav-tab.active');
            if (activeProjectSubViewButton) {
                if (activeProjectSubViewButton.textContent.includes("الأنميات")) sortAndLoadData('anime', currentSort.anime);
                else if (activeProjectSubViewButton.textContent.includes("المسلسلات")) sortAndLoadData('series', currentSort.series);
                else if (activeProjectSubViewButton.textContent.includes("الأرشيف")) loadArchivedProjects(getVal('archiveTypeFilter'));
            } else sortAndLoadData('anime', currentSort.anime); 
            loadSettings(); 
            updateRecentActivityDisplay(); 
        }

        function showTab(event, tabName) {
            requestAnimationFrame(() => {
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                const targetButton = event?.currentTarget || Array.from(document.querySelectorAll('.nav-tab')).find(btn => btn.onclick && btn.onclick.toString().includes(`'${tabName}'`));
                if (targetButton) targetButton.classList.add('active');
                
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                const currentTabPane = getEl(tabName);
                if (currentTabPane) currentTabPane.classList.add('active');

                const actions = {
                    'dashboard': updateDashboard, 
                    'members': () => sortAndLoadData('members', currentSort.members),
                    'projects': () => { 
                        const activeSubNav = document.querySelector('#projects .sub-nav-tab.active');
                        if (activeSubNav) activeSubNav.click(); 
                        else showProjectSubView('animeProjectsView', document.querySelector('#projects .sub-nav-tab[onclick*="animeProjectsView"]'));
                    },
                    'settings': loadSettings 
                };
                if (actions[tabName]) actions[tabName]();
                if (tabName === 'dashboard') updateRecentActivityDisplay();
            });
        }
        // ========== DASHBOARD STAT CARD NAVIGATION ==========
        function navigateToMembersTab() {
            showTab(null, 'members');
        }

        function navigateToProjectsTab() {
            showTab(null, 'projects');
            const animeSubNavButton = document.querySelector('#projects .sub-nav-tab[onclick*="animeProjectsView"]');
            if (animeSubNavButton) {
                showProjectSubView('animeProjectsView', animeSubNavButton);
            }
        }

        function navigateToArchiveTab() {
            showTab(null, 'projects');
            const archiveSubNavButton = document.querySelector('#projects .sub-nav-tab[onclick*="archiveProjectsView"]');
            if (archiveSubNavButton) {
                showProjectSubView('archiveProjectsView', archiveSubNavButton);
            }
        }

        function scrollToFinancialSummaries() {
            const dashboardTab = document.getElementById('dashboard');
            if (!dashboardTab.classList.contains('active')) {
                showTab(null, 'dashboard');
            }
            requestAnimationFrame(() => {
                const financialSection = document.getElementById('financialSummariesSectionContainer');
                if (financialSection) {
                    financialSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        }


        function showProjectSubView(viewId, clickedButton) {
            requestAnimationFrame(() => {
                document.querySelectorAll('#projects .sub-nav-tab').forEach(btn => btn.classList.remove('active'));
                if (clickedButton) clickedButton.classList.add('active');
                document.querySelectorAll('.project-sub-view').forEach(view => {
                    if (view.id === viewId) view.classList.add('active');
                    else view.classList.remove('active');
                });

                if (viewId === 'animeProjectsView') sortAndLoadData('anime', currentSort.anime);
                else if (viewId === 'seriesProjectsView') sortAndLoadData('series', currentSort.series);
                else if (viewId === 'archiveProjectsView') loadArchivedProjects(getVal('archiveTypeFilter'));
            });
        }

        function closeModal(modalId) {
            const el = getEl(modalId);
            if (el) {
                if (el.classList.contains('dropdown-menu')) { // For dropdowns
                    el.classList.add('hidden');
                } else { // For regular modals
                    el.style.display = 'none';
                }
            }
        }
        function getMoneyClass(amount) { const num = Number(amount); return num > 0 ? 'money-positive' : num === 0 ? 'money-zero' : 'money-negative'; }
        function formatMoney(amount) { const num = Number(amount); return `${num < 0 ? '-' : ''}$${Math.abs(num).toFixed(2)}`; }
        function generateUniqueId() { return Date.now().toString(36) + Math.random().toString(36).substring(2); }
        function formatDate(dateString) {
            if (!dateString) return '-';
            try { const date = new Date(dateString); if (isNaN(date.getTime())) { if (/^\d{4}(-\d{2})?$/.test(dateString)) return dateString; return dateString; } return date.toLocaleDateString('en-GB'); } catch (e) { return dateString; }
        }
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            try { const date = new Date(dateString); return date.toLocaleString('ar-EG', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }); } catch (e) { return dateString; }
        }
        function roleToArabic(role) { const map = {translator:'مترجم',editor:'مدقق',timer:'محاكي',subtitler:'موقت'}; return map[role]||role; }
        function getDurationInMinutes(item, itemType) { 
            let durationStr = itemType === 'anime' ? item.duration : itemType === 'series' ? item.seriesEpisodeRunTime : "";
            if (!durationStr) return 0; if (typeof durationStr === 'number') return durationStr;
            if (Array.isArray(durationStr)) { const nums = durationStr.map(d => parseInt(d, 10)).filter(n => !isNaN(n)); return nums.length > 0 ? nums[0] : 0; }
            const matches = String(durationStr).match(/(\d+)\s*hr/i) || String(durationStr).match(/(\d+)\s*min/i) || String(durationStr).match(/^\s*(\d+)\s*$/);
            return matches && matches[1] ? parseInt(matches[1]) * (String(durationStr).includes('hr') ? 60 : 1) : 0;
        }

        // ========== DATA PROCESSING & FILTERING/SORTING (incorporating Global Search) ==========
        function getProcessedItemsForType(type) { 
            let itemsToProcess = [];
            const projectConf = PROJECT_CONFIG[type];
            const statusFilterValue = projectConf ? getVal(projectConf.statusFilterId) : '';

            if (type === 'archive') {
                const archiveTypeFilter = getVal('archiveTypeFilter');
                const archivedAnime = data.anime.filter(p => p.status === 'مكتمل');
                const archivedSeries = data.series.filter(p => p.status === 'مكتمل');
                if (archiveTypeFilter === 'all' || archiveTypeFilter === 'anime') itemsToProcess.push(...archivedAnime.map(p => ({...p, projectTypeInternal: 'anime'})));
                if (archiveTypeFilter === 'all' || archiveTypeFilter === 'series') itemsToProcess.push(...archivedSeries.filter(s => !itemsToProcess.some(it => it.id === s.id)).map(p => ({...p, projectTypeInternal: 'series'})));
                if (globalSearchQuery) itemsToProcess = itemsToProcess.filter(p => 
                    p.name.toLowerCase().includes(globalSearchQuery) ||
                    (p.projectTypeInternal && p.projectTypeInternal.toLowerCase().includes(globalSearchQuery))
                );
            } else { 
                itemsToProcess = [...data[type === 'member' ? 'members' : type]]; 
                if (type === 'anime' || type === 'series') {
                    itemsToProcess = itemsToProcess.filter(p => p.status !== 'مكتمل'); 
                    if (statusFilterValue) itemsToProcess = itemsToProcess.filter(p => p.status === statusFilterValue);
                }
                if (globalSearchQuery) {
                    itemsToProcess = itemsToProcess.filter(item => {
                        let searchFields = [item.name];
                        if (type === 'member') {
                            searchFields.push(...(item.roles || []).map(roleToArabic));
                        } else { 
                            const currentConfig = PROJECT_CONFIG[type];
                            searchFields.push(item.status);
                            if (item.translatorId) { const member = data.members.find(m => m.id === item.translatorId); if(member) searchFields.push(member.name); }
                            searchFields.push(...(item[currentConfig.genreProperty] || []));
                        }
                        return searchFields.some(field => field && String(field).toLowerCase().includes(globalSearchQuery));
                    });
                }
            }

            const [field, order] = (currentSort[type === 'member' ? 'members' : type] || 'name_asc').split('_');
            const isAsc = order === 'asc';
            const sortVal = (item, fieldName) => {
                switch(fieldName) {
                    case 'name': return item.name.toLowerCase();
                    case 'lastDelivery': return item.lastDelivery ? new Date(item.lastDelivery).getTime() : (isAsc ? Infinity : -Infinity);
                    case 'totalProjectEpisodes': return (item.projectTranslatedEpisodes||0)+(item.projectEditedEpisodes||0)+(item.projectTimedEpisodes||0)+(item.projectSubtitledEpisodes||0);
                    case 'remainingAmount': return (item.totalFee || 0) - (item.amountReceived || 0);
                    case 'totalEpisodes': return item.totalEpisodes || 0;
                    case 'premiered': const dA = item.premiered ? (item.premiered.split('T')[0] || item.premiered) : null; return dA ? (new Date(dA).getTime() || parseInt(dA, 10) || 0) : (isAsc ? Infinity : -Infinity);
                    case 'seriesYear': return parseInt(item.seriesYear, 10) || (isAsc ? Infinity : -Infinity);
                    case 'status': const sO = { 'جارٍ': 1, 'قريباً': 2, 'متوقف': 3, 'مكتمل': 4 }; return sO[item.status] || 5;
                    case 'completionDate': return item.completionDate ? new Date(item.completionDate).getTime() : (isAsc ? Infinity : -Infinity);
                    case 'duration': return getDurationInMinutes(item, type === 'archive' ? item.projectTypeInternal : type);
                    default: return item.name.toLowerCase();
                }
            };
            itemsToProcess.sort((a, b) => {
                let valA = sortVal(a, field), valB = sortVal(b, field);
                if (valA < valB) return isAsc ? -1 : 1; if (valA > valB) return isAsc ? 1 : -1;
                if (field !== 'name') { let nA = a.name.toLowerCase(), nB = b.name.toLowerCase(); if (nA < nB) return -1; if (nA > nB) return 1; }
                return 0;
            });
            return itemsToProcess;
        }
        
        function handleGlobalSearch() {
            globalSearchQuery = getEl('globalSearchInput').value.toLowerCase().trim();
            const currentOpenTab = document.querySelector('.tab-pane.active')?.id;

            if (currentOpenTab) {
                if (currentOpenTab === 'dashboard') {
                    updateDashboard(); 
                } else if (currentOpenTab === 'members') {
                    sortAndLoadData('members', currentSort.members);
                } else if (currentOpenTab === 'projects') {
                    const activeSubNav = document.querySelector('#projects .sub-nav-tab.active');
                    const activeSubViewId = activeSubNav ? Array.from(activeSubNav.attributes).find(attr => attr.name === 'onclick')?.value.match(/'([^']+)'/)[1] : null;
                    if (activeSubViewId === 'animeProjectsView') sortAndLoadData('anime', currentSort.anime);
                    else if (activeSubViewId === 'seriesProjectsView') sortAndLoadData('series', currentSort.series);
                    else if (activeSubViewId === 'archiveProjectsView') loadArchivedProjects(getVal('archiveTypeFilter'));
                }
            }
        }


        function sortAndLoadData(type, sortValue) { 
            const effectiveType = type === 'member' ? 'members' : type;
            currentSort[effectiveType] = sortValue; 
            currentFilteredAndSortedItems[effectiveType] = getProcessedItemsForType(type);
            loadDataIntoGrid(type, currentFilteredAndSortedItems[effectiveType]); 
        }
        function filterProjects(type, statusFilter) { currentFilteredAndSortedItems[type] = getProcessedItemsForType(type); loadDataIntoGrid(type, currentFilteredAndSortedItems[type]); }

        // ========== GRID RENDERING & LAZY LOADING ==========
        function loadDataIntoGrid(type, itemsToLoad) { 
            const effectiveType = type === 'member' ? 'members' : type;
            const gridContainerId = PROJECT_CONFIG[effectiveType]?.cardGridId || `${effectiveType}CardGrid`;
            const gridContainer = getEl(gridContainerId);
            const placeholderId = `${effectiveType}CardPlaceholder`; 
            const placeholder = getEl(placeholderId);
            if (!gridContainer) return;

            requestAnimationFrame(() => {
                gridContainer.innerHTML = ''; 
                if (intersectionObservers[effectiveType]) { intersectionObservers[effectiveType].disconnect(); intersectionObservers[effectiveType] = null; }
                lazyLoadCounters[effectiveType] = 0; 

                if (itemsToLoad.length === 0) {
                    const entityName = type === 'members' ? 'أعضاء' : (PROJECT_CONFIG[type]?.nameLabel || 'عناصر');
                    if (placeholder) { placeholder.textContent = `لا يوجد ${entityName} لعرضهم.`; placeholder.style.display = 'block'; gridContainer.appendChild(placeholder); } 
                    else gridContainer.innerHTML = `<div class="card-placeholder">لا يوجد ${entityName} لعرضهم.</div>`;
                    updateMasterCheckbox(type); return;
                }
                if (placeholder) placeholder.style.display = 'none';
                currentFilteredAndSortedItems[effectiveType] = itemsToLoad; loadNextBatch(type); 
            });
        }

        function loadNextBatch(type) {
            const effectiveType = type === 'member' ? 'members' : type;
            const gridContainerId = PROJECT_CONFIG[effectiveType]?.cardGridId || `${effectiveType}CardGrid`;
            const gridContainer = getEl(gridContainerId);
            const templateId = type === 'members' ? 'memberCardTemplate' : 'projectCardTemplate';
            const template = getEl(templateId);
            if (!gridContainer || !template) return;

            const itemsToLoad = currentFilteredAndSortedItems[effectiveType];
            if (!itemsToLoad) return;

            const startIndex = lazyLoadCounters[effectiveType];
            const endIndex = Math.min(startIndex + LAZY_LOAD_BATCH_SIZE, itemsToLoad.length);
            const fragment = document.createDocumentFragment();

            for (let i = startIndex; i < endIndex; i++) {
                const item = itemsToLoad[i]; if (!item || !item.id) continue;
                const clone = template.content.cloneNode(true);
                const cardElement = clone.querySelector('.member-card, .project-card');
                cardElement.dataset.id = item.id; cardElement.style.cursor = 'default'; 
                let itemSpecificType = type === 'archive' ? (item.projectTypeInternal || (data.anime.some(a => a.id === item.id) ? 'anime' : 'series')) : type;
                cardElement.dataset.type = itemSpecificType; 
                type === 'members' ? populateMemberCard(cardElement, item) : populateProjectCard(cardElement, item, itemSpecificType);
                fragment.appendChild(clone);
            }
            
            requestAnimationFrame(() => {
                gridContainer.appendChild(fragment); lazyLoadCounters[effectiveType] = endIndex;
                const oldSentinel = gridContainer.querySelector('.lazy-load-sentinel'); if (oldSentinel) oldSentinel.remove();
                if (endIndex < itemsToLoad.length) {
                    const sentinel = document.createElement('div'); sentinel.className = 'lazy-load-sentinel'; gridContainer.appendChild(sentinel);
                    if (intersectionObservers[effectiveType]) intersectionObservers[effectiveType].disconnect();
                    intersectionObservers[effectiveType] = new IntersectionObserver(entries => { if (entries[0].isIntersecting) loadNextBatch(type); }, { rootMargin: '200px' });
                    intersectionObservers[effectiveType].observe(sentinel);
                }
                updateMasterCheckbox(type);
            });
        }
        
        function updateCardInDOM(originalType, itemId, itemData) {
            const typeForGrid = originalType === 'member' ? 'members' : originalType;
            const gridContainerId = PROJECT_CONFIG[typeForGrid]?.cardGridId || `${typeForGrid}CardGrid`;
            const cardElement = document.querySelector(`#${gridContainerId} .card[data-id="${itemId}"]`);

            if (cardElement && itemData) {
                requestAnimationFrame(() => {
                    const parent = cardElement.parentElement, scrollTop = parent ? parent.scrollTop : 0;
                    let itemSpecificType = originalType; 
                     if (originalType === 'archive' && itemData) { 
                        itemSpecificType = itemData.projectTypeInternal || (data.anime.some(a => a.id === itemId) ? 'anime' : 'series');
                    }

                    if (originalType === 'member') { 
                        populateMemberCard(cardElement, itemData);
                    } else { 
                        populateProjectCard(cardElement, itemData, itemSpecificType);
                    }
                    if (parent) parent.scrollTop = scrollTop;
                });
                return true; 
            }
            return false; 
        }
        
        function updateAffectedMembersDisplayDOM(memberIdsSet) { if (!memberIdsSet || memberIdsSet.size === 0) return; memberIdsSet.forEach(memberId => { const memberData = data.members.find(m => m.id === memberId); if (memberData) updateCardInDOM('member', memberId, memberData); }); } 

        // ========== CARD POPULATION ==========
        function populateMemberCard(card, member) {
            const avatarImg = card.querySelector('.member-avatar');
            avatarImg.src = member.avatarUrl || `https://placehold.co/60x60/718096/e5e7eb?text=${member.name.charAt(0)}`;
            avatarImg.alt = member.name; avatarImg.onclick = () => showImagePreview(avatarImg.src); 
            card.querySelector('.member-info h3').textContent = member.name;
            card.querySelector('.member-roles').innerHTML = (member.roles || []).map(role => `<span class="role-badge ${role}">${roleToArabic(role)}</span>`).join('');
            const totalEps = (member.projectTranslatedEpisodes||0)+(member.projectEditedEpisodes||0)+(member.projectTimedEpisodes||0)+(member.projectSubtitledEpisodes||0);
            const remaining = (member.totalFee || 0) - (member.amountReceived || 0);
            card.querySelector('.stat-value.episodes').textContent = totalEps;
            const duesEl = card.querySelector('.stat-value.dues'); duesEl.textContent = formatMoney(remaining); duesEl.className = `stat-value dues ${getMoneyClass(remaining)}`;
            card.querySelector('.stat-value.last-activity').textContent = member.lastDelivery ? formatDate(member.lastDelivery) : 'غير معروف';
            
            const socialLinks = card.querySelector('.social-links'); socialLinks.innerHTML = '';
            const addSocial = (handle, urlPrefix, iconClass, titleText, clickFn) => {
                if (handle) {
                    const url = handle.startsWith('@') ? `${urlPrefix}${handle.substring(1)}` : (isValidUrl(handle) ? handle : '#');
                    const effectiveTitle = titleText; 
                    socialLinks.innerHTML += clickFn ?
                        `<a href="#" onclick="${clickFn}" title="${effectiveTitle}"><i class="fab ${iconClass}"></i></a>` :
                        `<a href="${url}" target="_blank" title="${effectiveTitle}"><i class="fab ${iconClass}"></i></a>`;
                }
            };

            addSocial(member.twitterHandle, 'https://x.com/', 'fa-twitter', `X (Twitter): ${member.twitterHandle || ''}`);
            if (member.discordHandle) {
                if (isValidUrl(member.discordHandle)) {
                    addSocial(member.discordHandle, '', 'fa-discord', `Discord: ${member.discordHandle}`);
                } else {
                    const discordHandleDisplay = member.discordHandle;
                    const discordHandleForJs = member.discordHandle.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    const discordCopyFn = `navigator.clipboard.writeText('${discordHandleForJs}').then(() => showAlert('تم نسخ: ${discordHandleForJs}', 'success', 2000)).catch(err => showAlert('فشل النسخ.', 'danger')); return false;`;
                    addSocial(discordHandleDisplay, '#', 'fa-discord', `Discord: ${discordHandleDisplay} (اضغط للنسخ)`, discordCopyFn);
                }
            }
            addSocial(member.telegramHandle, 'https://t.me/', 'fa-telegram-plane', `Telegram: ${member.telegramHandle || ''}`);
            if (member.blog && isValidUrl(member.blog)) socialLinks.innerHTML += `<a href="${member.blog}" target="_blank" title="Blog/Website"><i class="fas fa-globe"></i></a>`;

            if (socialLinks.innerHTML === '') socialLinks.innerHTML = '-';
            card.querySelector('.edit-btn').onclick = () => showEntityModal('member', member.id);
            card.querySelector('.view-details-btn').onclick = () => showMemberDetailsModal(member.id);
            const checkbox = card.querySelector('.member-checkbox'); checkbox.onchange = () => toggleItemSelection('members', member.id); checkbox.checked = selectedItems.members.has(member.id);
        }

        function populateProjectCard(card, project, type) { 
            const config = PROJECT_CONFIG[type]; if (!config) return;
            card.dataset.type = type; 
            card.querySelector('.project-type-badge').textContent = type === 'anime' ? (project.animeType || 'أنمي') : 'مسلسل';
            card.querySelector('.project-title').textContent = project.name;
            const posterUrl = project[config.posterProperty] || 'https://placehold.co/100x140/242424/b0b0b0?text=N/A';
            const posterImg = card.querySelector('.project-poster img'); posterImg.src = posterUrl; posterImg.alt = project.name; posterImg.onclick = () => showImagePreview(posterUrl);
            let metaHtml = '';
            if(project[config.yearProperty]) metaHtml += `<span class="meta-item"><i class="fas fa-calendar"></i> ${formatDate(project[config.yearProperty])}</span>`;
            if(project[config.ratingProperty]) metaHtml += `<span class="meta-item"><i class="fas fa-star"></i> ${project[config.ratingProperty]}</span>`;
            const durationMins = getDurationInMinutes(project, type);
            if (durationMins > 0) metaHtml += `<span class="meta-item"><i class="fas fa-clock"></i> ${durationMins} دقيقة</span>`;
            else if (project[config.durationProperty]) metaHtml += `<span class="meta-item"><i class="fas fa-clock"></i> ${project[config.durationProperty]}</span>`; 
            if (type === 'anime' && project.studio) metaHtml += `<span class="meta-item"><i class="fas fa-building"></i> ${project.studio}</span>`;
            else if (type === 'series' && project.seriesNetwork) metaHtml += `<span class="meta-item"><i class="fas fa-tv"></i> ${project.seriesNetwork}</span>`;
            card.querySelector('.project-meta').innerHTML = metaHtml;
            card.querySelector('.project-genres').innerHTML = (project[config.genreProperty] || []).slice(0,3).map(g => `<span class="genre-tag">${g}</span>`).join('');
            const statusIndicator = card.querySelector('.status-indicator'); statusIndicator.textContent = project.status; statusIndicator.className = `status-indicator ${project.status.replace(/[ًٌٍَُِْ]/g,'').toLowerCase()}`; 
            const percent = project.totalEpisodes > 0 ? ((project.completedEpisodes / project.totalEpisodes) * 100) : 0;
            card.querySelector('.circular-progress .circle').style.strokeDasharray = `${percent}, 100`;
            card.querySelector('.progress-text .completed').textContent = project.completedEpisodes || 0;
            card.querySelector('.progress-text .total').textContent = project.totalEpisodes || '?';
            card.querySelector('.progress-label').textContent = project.status === 'مكتمل' && project.completionDate ? `تاريخ الإكمال: ${formatDate(project.completionDate)}` : `${percent.toFixed(1)}% مكتمل`;
            
            const episodeControls = card.querySelector('.circular-progress').parentElement;
            let increaseBtn = episodeControls.querySelector('.episode-increase'); if (!increaseBtn) { increaseBtn = document.createElement('button'); increaseBtn.className = 'episode-control-btn episode-increase'; increaseBtn.innerHTML = '+'; increaseBtn.title = 'زيادة حلقة منجزة'; card.querySelector('.circular-progress').insertAdjacentElement('afterend', increaseBtn); }
            let decreaseBtn = episodeControls.querySelector('.episode-decrease'); if (!decreaseBtn) { decreaseBtn = document.createElement('button'); decreaseBtn.className = 'episode-control-btn episode-decrease'; decreaseBtn.innerHTML = '−'; decreaseBtn.title = 'تقليل حلقة منجزة'; card.querySelector('.circular-progress').insertAdjacentElement('beforebegin', decreaseBtn); }
            decreaseBtn.disabled = (project.completedEpisodes || 0) <= 0; increaseBtn.disabled = project.totalEpisodes > 0 && (project.completedEpisodes || 0) >= project.totalEpisodes;
            decreaseBtn.onclick = (e) => { e.stopPropagation(); updateProjectEpisodes(type, project.id, -1); }; increaseBtn.onclick = (e) => { e.stopPropagation(); updateProjectEpisodes(type, project.id, 1); };
            
            const teamAvatarsContainer = card.querySelector('.project-team-avatars .avatar-group'); teamAvatarsContainer.innerHTML = ''; 
            const teamMembers = [...new Set([project.translatorId, project.editorId, project.timerId, project.subtitlerId].map(id => data.members.find(m => m.id === id)).filter(Boolean))];
            teamMembers.slice(0, 4).forEach(member => { const img = document.createElement('img'); img.src = member.avatarUrl || `https://placehold.co/30x30/718096/e5e7eb?text=${member.name.charAt(0)}`; img.alt = img.title = member.name; img.onclick = () => showImagePreview(img.src); img.style.cursor = 'pointer'; teamAvatarsContainer.appendChild(img); });
            
            const teamDetailsBtn = card.querySelector('.btn-team-details');
            if(teamDetailsBtn) teamDetailsBtn.onclick = () => showProjectTeamModal(project.id, type);
            
            const costCalcBtn = card.querySelector('.project-cost-calculator-btn');
            if (costCalcBtn) costCalcBtn.onclick = (e) => { e.stopPropagation(); toggleProjectCostPopup(project.id, type, card); };


            card.querySelector('.project-card-details-btn').onclick = () => showProjectDetailsModal(project.id, type);
            card.querySelector('.edit-btn').onclick = () => showEntityModal(type, project.id);
            const filesBtn = card.querySelector('.files-btn'); filesBtn.onclick = () => window.open(project.rawUrl || '#', '_blank'); filesBtn.disabled = !project.rawUrl;
            
            const extLink = card.querySelector(config.primaryLinkSelector); 
            if (extLink) { 
                const showLink = project[config.externalLinkProperty] && isValidUrl(project[config.externalLinkProperty]);
                extLink.classList.toggle('hidden', !showLink);
                if (showLink) extLink.href = project[config.externalLinkProperty];
            }
            const otherExtLink = card.querySelector(config.secondaryLinkSelector); if (otherExtLink) otherExtLink.classList.add('hidden');


            const archiveBtn = card.querySelector('.archive-btn');
            if (project.status === 'مكتمل') { archiveBtn.innerHTML = '<i class="fas fa-box-open"></i> إلغاء الأرشفة'; archiveBtn.onclick = () => toggleArchiveStatus(project.projectTypeInternal || type, project.id, false); archiveBtn.classList.remove('danger'); archiveBtn.classList.add('primary'); }
            else { archiveBtn.innerHTML = '<i class="fas fa-archive"></i> أرشفة'; archiveBtn.onclick = () => toggleArchiveStatus(type, project.id, true); archiveBtn.classList.remove('primary'); archiveBtn.classList.add('danger'); }
            
            const checkbox = card.querySelector('.project-card-checkbox');
            checkbox.style.display = (type === 'archive' || card.closest('#archiveCardGrid')) ? 'none' : '';
            if (checkbox.style.display !== 'none') { checkbox.onchange = () => toggleItemSelection(type, project.id); checkbox.checked = selectedItems[type] ? selectedItems[type].has(project.id) : false; }
        }

        function updateProjectEpisodes(projectType, projectId, change) {
            const project = data[projectType].find(p => p.id === projectId); if (!project) return;
            const currentCompleted = project.completedEpisodes || 0, totalEpisodes = project.totalEpisodes || 0;
            const newCompleted = currentCompleted + change;
            if (newCompleted < 0 || (totalEpisodes > 0 && newCompleted > totalEpisodes)) return;
            project.completedEpisodes = newCompleted;
            project.totalCost = (project.completedEpisodes * project.translationPrice) + (project.translationBonus || 0) + (project.completedEpisodes * project.editingPrice) + (project.editingBonus || 0) + (project.completedEpisodes * project.timerPrice) + (project.timerBonus || 0) + (project.completedEpisodes * project.subtitlerPrice) + (project.subtitlerBonus || 0);
            const affectedMemberIds = new Set([project.translatorId, project.editorId, project.timerId, project.subtitlerId].filter(Boolean));
            logRecentActivity(`تحديث حلقات مشروع (${projectType}) ${project.name}: ${change > 0 ? 'زيادة' : 'نقصان'} حلقة (${currentCompleted} ← ${newCompleted})`);
            unsavedChanges = true; recalculateSpecificMembersData(affectedMemberIds);
            saveData().then(success => { if (success) { updateCardInDOM(projectType, projectId, project); updateAffectedMembersDisplayDOM(affectedMemberIds); updateDashboard(); requestAnimationFrame(() => showAlert(`تم ${change > 0 ? 'زيادة' : 'تقليل'} حلقة بنجاح`, 'success', 1500)); } else unsavedChanges = true; });
        }

        // ========== MEMBER/PROJECT MODAL & SAVE LOGIC (UNIFIED) ==========
        function updateMemberDropdowns() {
            const populate = (id, role) => {
                const sel = getEl(id);
                if (!sel) {
                    return;
                }
                sel.innerHTML = '<option value="">اختر...</option>'; 
                
                data.members.filter(m => (m.roles || []).includes(role)).forEach(m => {
                    sel.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                });
                if (!Array.from(sel.options).some(o => o.selected)) {
                     sel.value = "";
                }
            };
            populate('projectTranslator', 'translator');
            populate('projectEditor', 'editor');
            populate('projectTimer', 'timer');
            populate('projectSubtitler', 'subtitler');
        }


        function showEntityModal(type, entityId = null) { 
            requestAnimationFrame(() => {
                const isMember = type === 'member';
                const projectConfig = !isMember ? PROJECT_CONFIG[type] : null;
                const form = getEl('entityForm'); form.reset(); 
                document.querySelectorAll('#entityForm input[type="checkbox"]').forEach(cb => cb.checked = false);

                setVal('entityId', entityId || ''); setVal('entityType', type);
                setText('entityModalTitle', entityId ? (isMember ? 'تعديل بيانات العضو' : projectConfig.modalTitleEdit) : (isMember ? 'إضافة عضو جديد' : projectConfig.modalTitleAdd));
                setText('entityNameLabel', (isMember ? 'اسم العضو' : projectConfig.nameLabel) + ' *');
                
                toggleVisibility('memberSpecificFields', isMember, false); 
                toggleVisibility('projectSpecificFields', !isMember, false); 

                if (!isMember && projectConfig) {
                    toggleVisibility(projectConfig.fieldsContainerId, true, false); 
                    toggleVisibility(projectConfig.altFieldsContainerId, false, false); 
                    updateMemberDropdowns(); 
                }
                
                if (entityId) {
                    const entity = isMember ? 
                        data.members.find(e => e.id === entityId) : 
                        data[type].find(e => e.id === entityId);
                    
                    if (!entity) { 
                        showAlert(`${isMember ? 'العضو' : 'المشروع'} غير موجود!`, 'danger'); 
                        return; 
                    }
                    setVal('entityName', entity.name);
                    if (isMember) {
                        setVal('memberAvatarUrl', entity.avatarUrl || '');
                        (entity.roles || []).forEach(role => setChecked(`role${role.charAt(0).toUpperCase() + role.slice(1)}`, true));
                        setVal('amountReceived', entity.amountReceived || 0); setVal('paymentMethod', entity.paymentMethod || '');
                        setVal('twitterHandle', entity.twitterHandle || ''); setVal('discordHandle', entity.discordHandle || '');
                        setVal('telegramHandle', entity.telegramHandle || ''); setVal('blog', entity.blog || ''); setVal('memberNotes', entity.notes || '');
                    } else { 
                        Object.keys(projectConfig.dataProperties).forEach(propKey => setVal(projectConfig.dataProperties[propKey], Array.isArray(entity[propKey]) ? entity[propKey].join(', ') : (entity[propKey] || '')));
                        if (type === 'anime') setVal('projectMalId', entity.malId || '');
                        if (type === 'series') setVal('projectSeriesNameSearch', entity.name); 
                        
                        projectConfig.formFields.forEach(fieldId => {
                            let valueToSet;
                            switch (fieldId) {
                                case 'projectStatus':           valueToSet = entity.status; break;
                                case 'completedEpisodesProject':valueToSet = entity.completedEpisodes; break;
                                case 'projectTranslator':       valueToSet = entity.translatorId; break;
                                case 'projectEditor':           valueToSet = entity.editorId; break;
                                case 'projectTimer':            valueToSet = entity.timerId; break;
                                case 'projectSubtitler':        valueToSet = entity.subtitlerId; break;
                                case 'projectNotes':            valueToSet = entity.notes; break;
                                default:
                                    const derivedPropertyName = fieldId.startsWith('project') ? fieldId.substring('project'.length).charAt(0).toLowerCase() + fieldId.substring('project'.length + 1) : fieldId;
                                    valueToSet = entity[derivedPropertyName] !== undefined ? entity[derivedPropertyName] : entity[fieldId];
                            }

                            if (projectConfig.selectFields.includes(fieldId) || fieldId === 'projectStatus') {
                                setVal(fieldId, valueToSet !== undefined && valueToSet !== null ? String(valueToSet) : '');
                            } else if (projectConfig.numberFields.includes(fieldId)) {
                                setVal(fieldId, valueToSet || 0);
                            } else {
                                setVal(fieldId, valueToSet || '');
                            }
                        });
                    }
                } else { 
                    if (isMember) { 
                        ['memberAvatarUrl', 'paymentMethod', 'twitterHandle', 'discordHandle', 'telegramHandle', 'blog', 'memberNotes'].forEach(id => setVal(id, '')); setVal('amountReceived', 0);
                    } else { 
                        [...(projectConfig.externalApiFields || []), ...projectConfig.formFields].forEach(id => { 
                            if(getEl(id)) getEl(id).value = projectConfig.numberFields.includes(id) ? 0 : ''; 
                        });
                        if (type === 'anime') setVal('projectMalId', '');
                        if (projectConfig && projectConfig.selectFields) {
                            projectConfig.selectFields.forEach(selId => {
                                if (selId !== 'projectStatus') { 
                                    setVal(selId, '');
                                }
                            });
                        }
                    }
                }
                setStyle('entityModal', 'display', 'block');
            });
        }

        function saveEntity() {
            const type = getVal('entityType'); 
            const entityId = getVal('entityId');
            const name = getVal('entityName');
            const isMember = type === 'member';
            
            let projectConfig = null;
            if (!isMember) {
                projectConfig = PROJECT_CONFIG[type];
                if (!projectConfig) {
                    showAlert('نوع مشروع غير صالح!', 'danger');
                    return;
                }
            }

            if (!name || (!isMember && !getVal('projectStatus'))) { showAlert(`يجب إدخال ${isMember ? 'اسم العضو' : projectConfig.nameLabel} واختيار الحالة.`, 'danger'); return; }
            
            let entityData = { name };
            let action = entityId ? 'تعديل' : 'إضافة';
            let savedEntityData;
            const affectedMemberIds = new Set(); 
            let oldProjectAssignments = null;

            if (isMember) {
                const avatarUrl = getVal('memberAvatarUrl'), twitterHandle = getVal('twitterHandle'), blog = getVal('blog'), telegramHandle = getVal('telegramHandle');
                if (avatarUrl && !isValidUrl(avatarUrl)) { showAlert('رابط صورة العضو غير صالح.', 'danger'); return; }
                if (twitterHandle && !isValidSocialHandle(twitterHandle, twitterPattern)) { showAlert('اسم مستخدم X (Twitter) غير صالح.', 'danger'); return; }
                if (telegramHandle && !isValidSocialHandle(telegramHandle, telegramPattern)) { showAlert('اسم مستخدم تيليجرام غير صالح.', 'danger'); return; }
                if (blog && !isValidUrl(blog)) { showAlert('رابط المدونة/الموقع غير صالح.', 'danger'); return; }
                const roles = []; ['Translator', 'Editor', 'Timer', 'Subtitler'].forEach(r => { if (isChecked(`role${r}`)) roles.push(r.toLowerCase()); });
                if (roles.length === 0) { showAlert('يجب اختيار دور واحد على الأقل للعضو.', 'danger'); return; }
                entityData = { ...entityData, avatarUrl: avatarUrl || null, roles, amountReceived: parseFloat(getVal('amountReceived')) || 0, paymentMethod: getVal('paymentMethod'), twitterHandle, discordHandle: getVal('discordHandle'), telegramHandle, blog, notes: getVal('memberNotes') };
                if (entityId) { const idx = data.members.findIndex(m => m.id === entityId); if (idx > -1) { data.members[idx] = { ...data.members[idx], ...entityData }; savedEntityData = data.members[idx]; } else return; }
                else { savedEntityData = { ...entityData, id: generateUniqueId(), createdDate: new Date().toISOString(), totalFee: 0, lastDelivery: null, projectTranslatedEpisodes:0, projectEditedEpisodes:0, projectTimedEpisodes:0, projectSubtitledEpisodes:0 }; data.members.push(savedEntityData); }
                recalculateSpecificMembersData(new Set([savedEntityData.id]));
            } else { 
                const completedEpisodes = parseInt(getVal('completedEpisodesProject'), 10) || 0;
                const totalEpisodes = parseInt(getVal('totalEpisodes'), 10) || 0;
                if (completedEpisodes > totalEpisodes && totalEpisodes !== 0) showAlert('عدد الحلقات المنجزة لا يمكن أن يكون أكبر من العدد الكلي.', 'warning');
                entityData = { ...entityData, status: getVal('projectStatus'), totalEpisodes, completedEpisodes,
                    translatorId: getVal('projectTranslator') || null, editorId: getVal('projectEditor') || null, timerId: getVal('projectTimer') || null, subtitlerId: getVal('projectSubtitler') || null,
                    translationPrice: parseFloat(getVal('translationPrice'))||0, editingPrice: parseFloat(getVal('editingPrice'))||0, timerPrice: parseFloat(getVal('timerPrice'))||0, subtitlerPrice: parseFloat(getVal('subtitlerPrice'))||0,
                    translationBonus: parseFloat(getVal('translationBonus'))||0, editingBonus: parseFloat(getVal('editingBonus'))||0, timerBonus: parseFloat(getVal('timerBonus'))||0, subtitlerBonus: parseFloat(getVal('subtitlerBonus'))||0,
                    rawUrl: getVal('rawUrl'), notes: getVal('projectNotes')
                };
                Object.keys(projectConfig.dataProperties).forEach(propKey => { let val = getVal(projectConfig.dataProperties[propKey]); if (['genres', 'themes', 'seriesGenres', 'seriesOriginCountry'].includes(propKey)) val = val ? val.split(',').map(s => s.trim()).filter(s => s) : []; else if (['score', 'seriesVoteAverage'].includes(propKey)) val = parseFloat(val) || null; entityData[propKey] = val || (Array.isArray([]) ? [] : null) ; });
                if (type === 'anime') entityData.malId = getVal('projectMalId') || null;
                entityData.totalCost = (entityData.completedEpisodes * entityData.translationPrice) + entityData.translationBonus + (entityData.completedEpisodes * entityData.editingPrice) + entityData.editingBonus + (entityData.completedEpisodes * entityData.timerPrice) + entityData.timerBonus + (entityData.completedEpisodes * entityData.subtitlerPrice) + entityData.subtitlerBonus;
                
                if (entityId) { const idx = data[type].findIndex(p => p.id === entityId); if (idx > -1) { const exP = data[type][idx]; oldProjectAssignments = { translatorId: exP.translatorId, editorId: exP.editorId, timerId: exP.timerId, subtitlerId: exP.subtitlerId }; Object.values(oldProjectAssignments).forEach(id => { if (id) affectedMemberIds.add(id); }); data[type][idx] = { ...exP, ...entityData }; savedEntityData = data[type][idx]; if (entityData.status === 'مكتمل' && !savedEntityData.completionDate) savedEntityData.completionDate = new Date().toISOString(); else if (entityData.status !== 'مكتمل') savedEntityData.completionDate = null; } else return; }
                else { savedEntityData = { ...entityData, id: generateUniqueId(), createdDate: new Date().toISOString() }; if (entityData.status === 'مكتمل') savedEntityData.completionDate = new Date().toISOString(); data[type].push(savedEntityData); }
                Object.values({ translatorId: savedEntityData.translatorId, editorId: savedEntityData.editorId, timerId: savedEntityData.timerId, subtitlerId: savedEntityData.subtitlerId }).forEach(id => { if (id) affectedMemberIds.add(id); });
                recalculateSpecificMembersData(affectedMemberIds); updateMemberFromProjectAssignment(oldProjectAssignments, savedEntityData); 
            }
            logRecentActivity(`${action} ${isMember ? 'عضو' : `مشروع (${type})`}: ${savedEntityData.name}`); 
            unsavedChanges = true;
            saveData().then(success => { 
                if(success) { 
                    const typeForDOMUpdate = isMember ? 'member' : type; 
                    if (!updateCardInDOM(typeForDOMUpdate, savedEntityData.id, savedEntityData)) {
                        sortAndLoadData(typeForDOMUpdate, currentSort[isMember ? 'members' : type]); 
                    }
                    if (isMember) updateMemberDropdowns(); 
                    else updateAffectedMembersDisplayDOM(affectedMemberIds); 
                    updateDashboard(); 
                    requestAnimationFrame(() => showAlert(`تم ${action} البيانات بنجاح.`, 'success')); 
                } else unsavedChanges = true; 
            });
            closeModal('entityModal');
        }

        function showMemberDetailsModal(memberId) {
            requestAnimationFrame(() => {
                const member = data.members.find(m => m.id === memberId); if (!member) { showAlert('لم يتم العثور على العضو!', 'danger'); return; }
                setText('memberDetailsModalTitle', `تفاصيل العضو: ${member.name}`);
                const avatarEl = getEl('memberDetailsAvatar'); avatarEl.src = member.avatarUrl || `https://placehold.co/120x120/718096/e5e7eb?text=${member.name.charAt(0)}`; avatarEl.onclick = () => showImagePreview(avatarEl.src); 
                setText('memberDetailsName', member.name); setHTML('memberDetailsRoles', (member.roles || []).map(role => `<span class="role-badge ${role}">${roleToArabic(role)}</span>`).join(''));
                
                const socialContainer = getEl('memberDetailsSocial'); socialContainer.innerHTML = ''; 
                const addSocialLink = (handle, urlPrefix, icon, titleText, clickFn) => {
                    if (handle) {
                        const url = handle.startsWith('@') ? `${urlPrefix}${handle.substring(1)}` : (isValidUrl(handle) ? handle : '#');
                        socialContainer.innerHTML += clickFn ? 
                            `<a href="#" onclick="${clickFn}" title="${titleText}"><i class="fab ${icon}"></i></a>` : 
                            `<a href="${url}" target="_blank" title="${titleText}"><i class="fab ${icon}"></i></a>`;
                    }
                };
                addSocialLink(member.twitterHandle, 'https://x.com/', 'fa-twitter', `X (Twitter): ${member.twitterHandle || ''}`);
                if (member.discordHandle) {
                    if (isValidUrl(member.discordHandle)) {
                        addSocialLink(member.discordHandle, '', 'fa-discord', `Discord: ${member.discordHandle}`);
                    } else {
                        const discordHandleDisplay = member.discordHandle;
                        const discordHandleForJs = member.discordHandle.replace(/'/g, "\\'").replace(/"/g, '\\"');
                        const discordCopyFn = `navigator.clipboard.writeText('${discordHandleForJs}').then(() => showAlert('تم نسخ: ${discordHandleForJs}', 'success', 2000)).catch(err => showAlert('فشل النسخ.', 'danger')); return false;`;
                        addSocialLink(discordHandleDisplay, '#', 'fa-discord', `Discord: ${discordHandleDisplay} (اضغط للنسخ)`, discordCopyFn);
                    }
                }
                addSocialLink(member.telegramHandle, 'https://t.me/', 'fa-telegram-plane', `Telegram: ${member.telegramHandle || ''}`);
                if (member.blog && isValidUrl(member.blog)) socialContainer.innerHTML += `<a href="${member.blog}" target="_blank" title="Blog/Website"><i class="fas fa-globe"></i></a>`;
                
                if (socialContainer.innerHTML === '') socialContainer.innerHTML = '<p class="text-sm text-muted">لا توجد حسابات تواصل.</p>';
                setText('memberDetailsPaymentMethod', member.paymentMethod || 'غير محدد'); setText('memberDetailsNotes', member.notes || 'لا توجد ملاحظات.');
                let projectsHtml = '';
                [...data.anime, ...data.series].forEach(project => {
                    let rolesInProject = [], projectType = data.anime.some(a => a.id === project.id) ? 'أنمي' : 'مسلسل';
                    if (project.translatorId === member.id) rolesInProject.push('مترجم'); if (project.editorId === member.id) rolesInProject.push('مدقق');
                    if (project.timerId === member.id) rolesInProject.push('محاكي'); if (project.subtitlerId === member.id) rolesInProject.push('موقت');
                    if (rolesInProject.length > 0) projectsHtml += `<div class="member-project-item"><strong>${project.name}</strong> (${projectType})<br>الأدوار: ${rolesInProject.join('، ')}<br>الحلقات المنجزة: ${project.completedEpisodes||0}/${project.totalEpisodes||'?'}</div>`;
                });
                setHTML('memberDetailsProjectsList', projectsHtml || '<p class="text-sm text-muted">لم يعمل هذا العضو على أي مشاريع.</p>');
                setStyle('memberDetailsModal', 'display', 'block');
            });
        }

        // ========== MEMBER DATA RECALCULATION ==========
        function recalculateSpecificMembersData(memberIdsSet) {
            if (!memberIdsSet || memberIdsSet.size === 0) return;
            memberIdsSet.forEach(memberId => {
                const member = data.members.find(m => m.id === memberId); if (!member) return;
                member.projectTranslatedEpisodes=0; member.projectEditedEpisodes=0; member.projectTimedEpisodes=0; member.projectSubtitledEpisodes=0; member.totalFee=0;
                [...data.anime, ...data.series].forEach(p => {
                    const eps = p.status === 'مكتمل' ? (p.totalEpisodes || p.completedEpisodes || 0) : (p.completedEpisodes || 0);
                    if (p.translatorId === member.id) { member.projectTranslatedEpisodes += (p.completedEpisodes||0); member.totalFee += (eps * (p.translationPrice||0)) + (p.translationBonus||0); }
                    if (p.editorId === member.id) { member.projectEditedEpisodes += (p.completedEpisodes||0); member.totalFee += (eps * (p.editingPrice||0)) + (p.editingBonus||0); }
                    if (p.timerId === member.id) { member.projectTimedEpisodes += (p.completedEpisodes||0); member.totalFee += (eps * (p.timerPrice||0)) + (p.timerBonus||0); }
                    if (p.subtitlerId === member.id) { member.projectSubtitledEpisodes += (p.completedEpisodes||0); member.totalFee += (eps * (p.subtitlerPrice||0)) + (p.subtitlerBonus||0); }
                });
                member.remainingAmount = (member.totalFee || 0) - (member.amountReceived || 0);
            });
        }
        function recalculateAllMemberData() { recalculateSpecificMembersData(new Set(data.members.map(m => m.id))); }
        function updateMemberFromProjectAssignment(oldAssignments, newProjectData) {
            const newAssignees = new Set([newProjectData.translatorId, newProjectData.editorId, newProjectData.timerId, newProjectData.subtitlerId].filter(Boolean));
            if (newProjectData.status === 'جارٍ' || newProjectData.status === 'مكتمل') {
                const deliveryDate = newProjectData.completionDate || new Date().toISOString(); 
                newAssignees.forEach(memberId => { const member = data.members.find(m => m.id === memberId); if (member && (!member.lastDelivery || new Date(deliveryDate) > new Date(member.lastDelivery))) member.lastDelivery = deliveryDate; });
            }
        }

        // ========== SELECTION & DELETION ==========
        function toggleItemSelection(type, itemId) { 
            const set = selectedItems[type] || new Set(); 
            set.has(itemId) ? set.delete(itemId) : set.add(itemId); 
            selectedItems[type] = set; 
            updateMasterCheckbox(type); 
            updateDeleteButtonText(type); 
        }

        function updateMasterCheckbox(type) { 
            const conf = PROJECT_CONFIG[type]; 
            let masterCbId = conf ? conf.selectAllCheckboxId : (type === 'members' ? 'selectAllMembersCard' : null);
            if (type === 'archive' || !masterCbId) return; 
            const masterCb = getEl(masterCbId); if (!masterCb) return;
            const allItems = currentFilteredAndSortedItems[type]; if (!allItems || allItems.length === 0) { masterCb.checked = false; masterCb.indeterminate = false; return; }
            const visibleSelectedCount = allItems.filter(item => selectedItems[type] && selectedItems[type].has(item.id)).length;
            masterCb.checked = allItems.length > 0 && visibleSelectedCount === allItems.length;
            masterCb.indeterminate = visibleSelectedCount > 0 && visibleSelectedCount < allItems.length;
        }

        function toggleSelectAllCards(type) { 
            const conf = PROJECT_CONFIG[type]; 
            let masterCbId = conf ? conf.selectAllCheckboxId : (type === 'members' ? 'selectAllMembersCard' : null); 
            if (!masterCbId) return;
            const masterCb = getEl(masterCbId), isChecked = masterCb.checked, items = currentFilteredAndSortedItems[type]; 
            if (!selectedItems[type]) selectedItems[type] = new Set();
            items.forEach(item => isChecked ? selectedItems[type].add(item.id) : selectedItems[type].delete(item.id));
            requestAnimationFrame(() => { 
                const gridId = conf ? conf.cardGridId : `${type}CardGrid`; 
                const grid = getEl(gridId); 
                if (grid) { 
                    const cbSelector = type === 'members' ? '.member-checkbox' : '.project-card-checkbox'; 
                    grid.querySelectorAll(type==='members'?'.member-card':'.project-card').forEach(card => { 
                        const cb=card.querySelector(cbSelector); 
                        if (cb && items.some(it=>it.id===card.dataset.id)) cb.checked=isChecked; 
                    }); 
                } 
                masterCb.indeterminate=false; 
                updateDeleteButtonText(type); 
            });
        }

        function updateDeleteButtonText(type) { 
            const count = selectedItems[type] ? selectedItems[type].size : 0;
            const btn = document.querySelector(type === 'members' ? '#members .toolbar .btn-danger' : (type === 'anime' ? '#animeProjectsView .toolbar .btn-danger' : '#seriesProjectsView .toolbar .btn-danger'));
            if (btn) btn.innerHTML = `<i class="fas fa-trash-alt"></i> حذف المحدد ${count > 0 ? `(${count})` : ''}`;
        }
        function deleteSelected(type) { 
            if(!selectedItems[type] || selectedItems[type].size === 0){requestAnimationFrame(() => showAlert('يرجى تحديد عناصر للحذف أولاً.','warning'));return;}
            if(confirm(`هل أنت متأكد من حذف ${selectedItems[type].size} عنصر/عناصر محددة؟`)){
                const idsToDelete = new Set(selectedItems[type]), deletedNames = [];
                data[type] = data[type].filter(item => { if (idsToDelete.has(item.id)) { deletedNames.push(item.name); return false; } return true; });
                selectedItems[type].clear(); updateDeleteButtonText(type);
                const conf = PROJECT_CONFIG[type]; let masterCbId = conf ? conf.selectAllCheckboxId : (type === 'members' ? 'selectAllMembersCard' : null); if (masterCbId) { const mCb=getEl(masterCbId); if(mCb){mCb.checked=false;mCb.indeterminate=false;} }
                logRecentActivity(`حذف متعدد ${type}: ${deletedNames.join(', ')}`);
                unsavedChanges = true;
                if(type === 'members'){ const affectedPIds = new Set(); [data.anime, data.series].forEach(pList => pList.forEach(p => { let ch=false; if(idsToDelete.has(p.translatorId)){p.translatorId=null;ch=true;} if(idsToDelete.has(p.editorId)){p.editorId=null;ch=true;} if(idsToDelete.has(p.timerId)){p.timerId=null;ch=true;} if(idsToDelete.has(p.subtitlerId)){p.subtitlerId=null;ch=true;} if(ch)affectedPIds.add(p.id); })); affectedPIds.forEach(pId => { let p=data.anime.find(pr=>pr.id===pId)||data.series.find(pr=>pr.id===pId); if(p){p.totalCost=(p.completedEpisodes*(p.translationPrice||0))+(p.translationBonus||0)+(p.completedEpisodes*(p.editingPrice||0))+(p.editingBonus||0)+(p.completedEpisodes*(p.timerPrice||0))+(p.timerBonus||0)+(p.completedEpisodes*(p.subtitlerPrice||0))+(p.subtitlerBonus||0);const pTypeDOM=data.anime.some(a=>a.id===pId)?'anime':'series';updateCardInDOM(pTypeDOM,pId,p);} }); sortAndLoadData('members', currentSort.members); updateMemberDropdowns(); } 
                else sortAndLoadData(type, currentSort[type]); 
                recalculateAllMemberData(); saveData().then(s => { if(!s) unsavedChanges = true; }); updateDashboard(); requestAnimationFrame(() => showAlert(`تم حذف العناصر المحددة بنجاح.`,'success'));
            }
        }

        // ========== DATA IMPORT/EXPORT & CLEAR ==========
        function exportAllData() { downloadFile(JSON.stringify(data, null, 2), `ReviveSubs_FullBackup_${new Date().toISOString().split('T')[0]}.json`, 'application/json;charset=utf-8;'); logRecentActivity('تصدير جميع البيانات (JSON)'); requestAnimationFrame(() => showAlert('تم تصدير جميع البيانات بنجاح.', 'success')); }
        function importData() {
            const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (file && confirm('سيؤدي استيراد البيانات إلى الكتابة فوق جميع البيانات الحالية. هل أنت متأكد؟')) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            const defaultStructure = initializeDefaultDataStructure(false);
                            if (imported && imported.settings && Array.isArray(imported.members) && Array.isArray(imported.anime) && Array.isArray(imported.series)) {
                                data = { ...defaultStructure, ...imported }; data.settings = { ...defaultStructure.settings, ...(imported.settings || {}) };
                                data.members.forEach(m => { /* Manual episode field deletion removed as per request */ });
                                if (!Array.isArray(data.recentActivityLog)) data.recentActivityLog = []; 
                                await saveData(); unsavedChanges = false; logRecentActivity(`استيراد ملف: ${file.name}`); requestAnimationFrame(() => showAlert('تم استيراد البيانات بنجاح.', 'success')); updateAllDisplays(); 
                            } else requestAnimationFrame(() => showAlert('ملف الاستيراد غير صالح.', 'danger'));
                        } catch (error) { console.error("Error importing data:", error); requestAnimationFrame(() => showAlert('خطأ أثناء استيراد البيانات.', 'danger')); }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        function downloadFile(content, filename, contentType) { const a = document.createElement('a'), file = new Blob([content],{type:contentType}); a.href=URL.createObjectURL(file); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }

        // ========== EXTERNAL API FETCHING (MAL & TMDB) ==========
        const JIKAN_API_BASE_URL = "https://api.jikan.moe/v4", TMDB_API_BASE_URL = "https://api.themoviedb.org/3", TMDB_API_KEY = "6b65819086d354cbdf267b26693c4147"; 
        async function fetchExternalData(type) { 
            const config = PROJECT_CONFIG[type];
            setDisabled(config.fetchButtonId, true); toggleVisibility(config.fetchLoaderId, true, false); 
            try {
                if (type === 'anime') {
                    let malId = getVal('projectMalId');
                    if (!malId && getVal('projectUrl')) { const m = getVal('projectUrl').match(/myanimelist\.net\/anime\/(\d+)/); if (m && m[1]) { malId = m[1]; setVal('projectMalId', malId); } }
                    if (!malId) { showAlert('يرجى إدخال معرف MAL أو رابط MAL صالح.', 'warning'); return; }
                    const resp = await fetch(`${JIKAN_API_BASE_URL}/anime/${malId}`); if (!resp.ok) { const err = await resp.json(); throw new Error(`MAL ${resp.status}: ${err.message || 'فشل'}`); }
                    const d = (await resp.json()).data;
                    requestAnimationFrame(() => { setVal('entityName', d.title || d.title_english || d.title_japanese || ''); setVal('projectUrl', d.url || ''); setVal('projectImageUrl', d.images?.jpg?.large_image_url || d.images?.jpg?.image_url || ''); setVal('projectAnimeType', d.type || ''); setVal('projectStudio', (d.studios || []).map(s => s.name).join(', ') || ''); setVal('projectSource', d.source || ''); setVal('projectPremiered', d.aired?.from ? new Date(d.aired.from).toLocaleDateString('en-CA') : (d.year || '')); setVal('projectGenres', (d.genres || []).map(g => g.name).join(', ')); setVal('projectThemes', (d.themes || []).map(t => t.name).join(', ')); setVal('totalEpisodes', d.episodes || ''); setVal('projectDuration', d.duration || ''); setVal('projectRating', d.rating || ''); setVal('projectScore', d.score || ''); setVal('projectNotes', d.synopsis || ''); showAlert('تم جلب بيانات MAL!', 'success'); });
                } else if (type === 'series') {
                    const seriesName = getVal('projectSeriesNameSearch'); if (!seriesName) { showAlert('يرجى إدخال اسم المسلسل للبحث.', 'warning'); return; }
                    if (!TMDB_API_KEY || TMDB_API_KEY === "YOUR_TMDB_API_KEY") { showAlert('مفتاح TMDB API غير مهيأ.', 'danger'); return; }
                    const resp = await fetch(`${TMDB_API_BASE_URL}/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(seriesName)}&language=ar-SA&include_adult=false`); if (!resp.ok) throw new Error(`TMDB Search ${resp.status}: فشل`);
                    const searchData = await resp.json();
                    requestAnimationFrame(() => { const list = getEl('tmdbResultsList'); list.innerHTML = ''; if (searchData.results && searchData.results.length > 0) { searchData.results.slice(0, 10).forEach(s => { const li = document.createElement('li'); li.style.cssText = "padding:10px;border-bottom:1px solid var(--border-color);cursor:pointer;"; const year = s.first_air_date ? `(${new Date(s.first_air_date).getFullYear()})` : ''; li.textContent = `${s.name} ${year}`; li.onclick = () => { fetchTmdbSeriesDetails(s.id); closeModal('tmdbResultsModal'); }; list.appendChild(li); }); setStyle('tmdbResultsModal', 'display', 'block'); } else showAlert('لم يتم العثور على نتائج.', 'info'); });
                }
            } catch (error) { console.error(`Error fetching ${type} data:`, error); requestAnimationFrame(() => showAlert(`فشل جلب بيانات ${type}: ${error.message}`, 'danger')); }
            finally { setDisabled(config.fetchButtonId, false); toggleVisibility(config.fetchLoaderId, false, false); } 
        }
        async function fetchTmdbSeriesDetails(seriesId) {
            setDisabled(PROJECT_CONFIG.series.fetchButtonId, true); toggleVisibility(PROJECT_CONFIG.series.fetchLoaderId, true, false); 
            try { const resp = await fetch(`${TMDB_API_BASE_URL}/tv/${seriesId}?api_key=${TMDB_API_KEY}&language=ar-SA`); if (!resp.ok) throw new Error(`TMDB Details ${resp.status}: فشل`); const d = await resp.json();
                requestAnimationFrame(() => { setVal('entityName', d.name || ''); setVal('projectTmdbUrl', `https://www.themoviedb.org/tv/${d.id}`); setVal('projectSeriesYear', d.first_air_date ? new Date(d.first_air_date).getFullYear().toString() : ''); setVal('projectSeriesNetwork', (d.networks || []).map(n => n.name).join(', ')); setVal('projectSeriesStatusTMDB', d.status || ''); setVal('projectSeriesOverview', d.overview || ''); setVal('projectSeriesGenres', (d.genres || []).map(g => g.name).join(', ')); setVal('totalEpisodes', d.number_of_episodes || ''); setVal('projectSeriesVoteAverage', d.vote_average ? d.vote_average.toFixed(1) : ''); setVal('projectSeriesPosterUrl', d.poster_path ? `https://image.tmdb.org/t/p/w500${d.poster_path}` : ''); setVal('projectSeriesOriginCountry', (d.origin_country || []).join(', ')); setVal('projectSeriesOriginalLanguage', d.original_language || ''); setVal('projectSeriesEpisodeRunTime', (d.episode_run_time || []).join(', ') || ''); setVal('projectNotes', d.tagline || ''); showAlert('تم جلب بيانات TMDB!', 'success'); });
            } catch (error) { console.error("Error fetching TMDB details:", error); requestAnimationFrame(() => showAlert(`فشل جلب تفاصيل TMDB: ${error.message}`, 'danger')); }
            finally { setDisabled(PROJECT_CONFIG.series.fetchButtonId, false); toggleVisibility(PROJECT_CONFIG.series.fetchLoaderId, false, false); } 
        }

        // ========== ARCHIVING LOGIC ==========
        function toggleArchiveStatus(type, projectId, archive) {
            const projectIndex = data[type].findIndex(p => p.id === projectId);
            if (projectIndex > -1) {
                const project = data[type][projectIndex];
                if (archive && project.status !== 'مكتمل' && !confirm('هذا المشروع ليس مكتملاً. هل تريد أرشفته وتحديث حالته إلى "مكتمل"؟')) return;
                
                const newStatus = archive ? 'مكتمل' : (prompt('يرجى تحديد الحالة الجديدة للمشروع (مثال: جارٍ، متوقف، قريباً):', 'جارٍ'));
                
                if (!newStatus || (archive && newStatus !== 'مكتمل') || (!archive && !['جارٍ', 'متوقف', 'قريباً'].includes(newStatus))) { 
                    if (!archive && newStatus !== null) { 
                         requestAnimationFrame(() => showAlert('الحالة المدخلة غير صالحة. لم يتم تحديث حالة الأرشفة.', 'warning'));
                    }
                    return; 
                }
                
                project.status = newStatus; 
                project.completionDate = archive ? (project.completionDate || new Date().toISOString()) : null;
                
                logRecentActivity(`${archive ? 'أرشفة' : 'إلغاء أرشفة'} مشروع (${type}) ${project.name} -> ${newStatus}`);
                unsavedChanges = true;
                
                saveData().then(success => { 
                    if(success) { 
                        sortAndLoadData(type, currentSort[type]); 
                        loadArchivedProjects(getVal('archiveTypeFilter')); 
                        updateDashboard(); 
                        requestAnimationFrame(() => showAlert(`تم ${archive ? 'أرشفة' : 'إلغاء أرشفة'} المشروع بنجاح.`, 'success')); 
                    } else {
                        unsavedChanges = true; 
                    }
                });
            }
        }
        function loadArchivedProjects(filterType = 'all') { 
            currentFilteredAndSortedItems.archive = getProcessedItemsForType('archive'); 
            loadDataIntoGrid('archive', currentFilteredAndSortedItems.archive); 
        }

        // ========== RECENT ACTIVITY LOG ==========
        function logRecentActivity(message) { 
            if (!data.recentActivityLog) data.recentActivityLog = [];
            data.recentActivityLog.unshift({timestamp: new Date().toISOString(), message: message}); 
            if (data.recentActivityLog.length > 50) data.recentActivityLog.pop(); 
            
            if (getEl('dashboard').classList.contains('active')) {
                updateRecentActivityDisplay();
            }
        }

        function updateRecentActivityDisplay() {
            requestAnimationFrame(() => {
                const listEl = getEl('recentActivityList');
                if (!listEl) return;
                
                const activitiesToDisplay = getProcessedRecentActivity().slice(0, 10); 

                if (activitiesToDisplay.length === 0) {
                    listEl.innerHTML = `<li class="text-center text-muted">لا يوجد نشاط حديث${globalSearchQuery ? ' يطابق بحثك' : ''}.</li>`;
                    return;
                }
                
                let html = '';
                activitiesToDisplay.forEach(activity => {
                    html += `<li>${activity.message} <span class="activity-time">${formatDateTime(activity.timestamp)}</span></li>`;
                });
                listEl.innerHTML = html;
            });
        }
        
        function getProcessedRecentActivity() {
            let activities = [...(data.recentActivityLog || [])];
            if (globalSearchQuery) {
                activities = activities.filter(activity =>
                    activity.message.toLowerCase().includes(globalSearchQuery)
                );
            }
            return activities;
        }


        // ========== MODAL DISPLAY LOGIC (Team & Details) ==========
        function showProjectTeamModal(projectId, projectType) { 
            requestAnimationFrame(() => {
                const modalBody = getEl('projectTeamModalBody'); modalBody.innerHTML = '<div class="spinner"></div>'; 
                let project = data[projectType]?.find(p => p.id === projectId) || data.anime.find(p => p.id === projectId && p.status === 'مكتمل') || data.series.find(p => p.id === projectId && p.status === 'مكتمل');
                if (!project) { modalBody.innerHTML = '<p class="text-center text-muted">لم يتم العثور على المشروع.</p>'; setText('projectTeamModalTitle', 'فريق عمل المشروع'); setStyle('projectTeamModal', 'display', 'block'); return; }
                setText('projectTeamModalTitle', `فريق عمل: ${project.name}`); let teamHtml = ''; let hasMembers = false;
                const roles = [{role:'مترجم',id:project.translatorId,price:project.translationPrice,bonus:project.translationBonus}, {role:'مدقق',id:project.editorId,price:project.editingPrice,bonus:project.editingBonus}, {role:'محاكي',id:project.timerId,price:project.timerPrice,bonus:project.timerBonus}, {role:'موقت',id:project.subtitlerId,price:project.subtitlerPrice,bonus:project.subtitlerBonus}];
                roles.forEach(item => { if (item.id) { const member = data.members.find(m => m.id === item.id); if (member) { hasMembers = true; const payment = (project.completedEpisodes||0)*(item.price||0)+(item.bonus||0); teamHtml += `<div class="team-member-item"><img src="${member.avatarUrl||`https://placehold.co/40x40/718096/e5e7eb?text=${member.name.charAt(0)}`}" alt="${member.name}"><div class="team-member-info"><h5>${member.name}</h5><p><span class="role">${item.role}</span></p><p>الأجر: <span class="payment ${getMoneyClass(payment)}">${formatMoney(payment)}</span> (سعر الحلقة: ${formatMoney(item.price||0)}, إضافي/خصم: ${formatMoney(item.bonus||0)})</p></div></div>`; } } });
                modalBody.innerHTML = hasMembers ? teamHtml : '<p class="text-center text-muted">لم يتم تعيين أعضاء لهذا المشروع.</p>'; setStyle('projectTeamModal', 'display', 'block');
            });
        }
        function showProjectDetailsModal(projectId, projectType) {
            requestAnimationFrame(() => {
                const project = data[projectType]?.find(p => p.id === projectId); if (!project) { showAlert('لم يتم العثور على المشروع!', 'danger'); return; }
                const config = PROJECT_CONFIG[projectType]; if (!config) { showAlert('نوع مشروع غير صالح!', 'danger'); return; }
                setText('projectDetailsModalTitle', `تفاصيل: ${project.name}`); const modalBody = getEl('projectDetailsModalBody'); modalBody.innerHTML = '';
                const addSection = (titleIcon, titleText, contentHtml) => { const section = document.createElement('div'); section.className = 'project-modal-section'; section.innerHTML = `<h5><i class="fas ${titleIcon}"></i> ${titleText}</h5>${contentHtml}`; modalBody.appendChild(section); };
                let extInfo = '<div class="info-grid">'; const addInfoItem = (lbl, val, isLink) => { if (val) extInfo += `<div class="info-item"><label>${lbl}:</label> <span>${isLink ? `<a href="${val}" target="_blank" style="color:var(--accent-blue);">${val}</a>` : val}</span></div>`; };
                addInfoItem('الحلقات', project.totalEpisodes); addInfoItem(`رابط ${config.externalLinkName}`, project[config.externalLinkProperty], true);
                if (projectType === 'anime') { addInfoItem('النوع',project.animeType); addInfoItem('أول عرض',formatDate(project.premiered)); addInfoItem('الاستوديو',project.studio); addInfoItem('المصدر',project.source); addInfoItem('التصنيفات',(project.genres||[]).join(', ')); addInfoItem('المواضيع',(project.themes||[]).join(', ')); addInfoItem('المدة',project.duration); addInfoItem('التصنيف العمري',project.rating); addInfoItem('التقييم',project.score); }
                else { addInfoItem('سنة أول عرض',project.seriesYear); addInfoItem('الشبكة',project.seriesNetwork); addInfoItem('التصنيفات',(project.seriesGenres||[]).join(', ')); addInfoItem('متوسط التقييم',project.seriesVoteAverage); addInfoItem('رابط البوستر',project.seriesPosterUrl,true); addInfoItem('بلد المنتج',(project.seriesOriginCountry||[]).join(', ')); addInfoItem('اللغة الأصلية',project.seriesOriginalLanguage); addInfoItem('مدة الحلقة',`${project.seriesEpisodeRunTime} دقيقة`); }
                extInfo += '</div>'; if (projectType==='series'&&project.seriesOverview) extInfo+=`<p class="series-overview-modal">${project.seriesOverview}</p>`;
                addSection('fa-info-circle', 'معلومات إضافية', extInfo || '<p class="text-sm text-muted">لا توجد.</p>');
                let costHtml = '<div class="cost-breakdown">'; const addCostItem = (lbl,cost) => { if(cost!==undefined && cost!==null) costHtml+=`<div class="cost-item"><span>${lbl}:</span> <span>${formatMoney(cost)}</span></div>`; };
                if(project.translatorId) addCostItem('الترجمة',(project.completedEpisodes||0)*(project.translationPrice||0)+(project.translationBonus||0)); if(project.editorId) addCostItem('التدقيق',(project.completedEpisodes||0)*(project.editingPrice||0)+(project.editingBonus||0)); if(project.timerId) addCostItem('المحاكاة',(project.completedEpisodes||0)*(project.timerPrice||0)+(project.timerBonus||0)); if(project.subtitlerId) addCostItem('التوقيت',(project.completedEpisodes||0)*(project.subtitlerPrice||0)+(project.subtitlerBonus||0));
                costHtml += `<div class="cost-item total"><span>الإجمالي (للحلقات المنجزة):</span> <span>${formatMoney(project.totalCost||0)}</span></div></div>`;
                addSection('fa-dollar-sign', 'التفاصيل المالية', costHtml);
                addSection('fa-sticky-note', 'الملاحظات', `<div class="project-notes-modal-content"><p>${project.notes || 'لا توجد.'}</p></div>`);
                setStyle('projectDetailsModal', 'display', 'block');
            });
        }

        // ========== PROJECT COST CALCULATOR POPUP ==========
        function toggleProjectCostPopup(projectId, projectType, cardElement) {
            const popup = cardElement.querySelector('.project-cost-details-popup');
            const contentDiv = popup.querySelector('.cost-popup-content');
            const project = data[projectType]?.find(p => p.id === projectId);

            if (!project) {
                contentDiv.innerHTML = '<p class="text-muted">خطأ: لم يتم العثور على المشروع.</p>';
                popup.classList.remove('hidden');
                return;
            }

            if (popup.classList.contains('hidden') || popup.dataset.activeFor !== projectId) { 
                let html = '';
                const completedEps = project.completedEpisodes || 0;
                const totalEps = project.totalEpisodes || 0;

                html += `<p><strong>التكلفة الحالية (${completedEps} حلقة):</strong> ${formatMoney(project.totalCost || 0)}</p>`;

                if (totalEps > 0 && completedEps < totalEps) {
                    const costAtCompletion = 
                        (totalEps * (project.translationPrice || 0)) + (project.translationBonus || 0) +
                        (totalEps * (project.editingPrice || 0)) + (project.editingBonus || 0) +
                        (totalEps * (project.timerPrice || 0)) + (project.timerBonus || 0) +
                        (totalEps * (project.subtitlerPrice || 0)) + (project.subtitlerBonus || 0);
                    html += `<p><strong>التكلفة عند الاكتمال (${totalEps} حلقة):</strong> ${formatMoney(costAtCompletion)}</p>`;
                } else if (totalEps > 0 && completedEps >= totalEps) {
                     html += `<p><strong>المشروع مكتمل بالتكلفة الحالية.</strong></p>`;
                }


                html += '<hr style="border-color: var(--border-color); margin: 10px 0;"><h5>مستحقات الأعضاء:</h5>';
                
                const roles = [
                    { name: 'المترجم', id: project.translatorId, price: project.translationPrice, bonus: project.translationBonus },
                    { name: 'المدقق', id: project.editorId, price: project.editingPrice, bonus: project.editingBonus },
                    { name: 'المحاكي', id: project.timerId, price: project.timerPrice, bonus: project.timerBonus },
                    { name: 'الموقت', id: project.subtitlerId, price: project.subtitlerPrice, bonus: project.subtitlerBonus }
                ];

                let memberPaymentsHtml = '';
                roles.forEach(role => {
                    if (role.id) {
                        const member = data.members.find(m => m.id === role.id);
                        if (member) {
                            const currentPayment = (completedEps * (role.price || 0)) + (role.bonus || 0);
                            memberPaymentsHtml += `<p><strong>${role.name} (${member.name}):</strong><br>`;
                            memberPaymentsHtml += `&nbsp;&nbsp;&nbsp;حاليًا: ${formatMoney(currentPayment)}`;
                            if (totalEps > 0 && completedEps < totalEps) {
                                const paymentAtCompletion = (totalEps * (role.price || 0)) + (role.bonus || 0);
                                memberPaymentsHtml += ` | عند الاكتمال: ${formatMoney(paymentAtCompletion)}`;
                            }
                            memberPaymentsHtml += `</p>`;
                        }
                    }
                });
                html += memberPaymentsHtml || '<p class="text-muted">لم يتم تعيين أعضاء لهذا المشروع.</p>';

                contentDiv.innerHTML = html;
                popup.classList.remove('hidden');
                popup.dataset.activeFor = projectId;

                popup.querySelector('.close-cost-popup').onclick = (e) => {
                    e.stopPropagation();
                    popup.classList.add('hidden');
                    delete popup.dataset.activeFor;
                };
                setTimeout(() => { 
                    document.addEventListener('click', function closeCostPopupHandler(event) {
                        if (!popup.contains(event.target) && !cardElement.querySelector('.project-cost-calculator-btn').contains(event.target)) {
                            popup.classList.add('hidden');
                            delete popup.dataset.activeFor;
                            document.removeEventListener('click', closeCostPopupHandler);
                        }
                    });
                }, 0);


            } else { 
                popup.classList.add('hidden');
                delete popup.dataset.activeFor;
            }
        }


        // ========== ALERTS & IMAGE PREVIEW ==========
        function showAlert(message, type = 'info', duration = 3000) { requestAnimationFrame(() => { const alertDiv = document.createElement('div'); alertDiv.className = `alert alert-${type}`; alertDiv.textContent = message; document.body.appendChild(alertDiv); setTimeout(() => alertDiv.remove(), duration); }); }
        function showImagePreview(src) { requestAnimationFrame(() => { if (src && !src.startsWith('https://placehold.co/')) { getEl('previewImage').src = src; setStyle('imagePreviewModal','display','flex'); } }); }
        
        // ========== DASHBOARD & STATISTICS ==========
        function updateDashboard() { requestAnimationFrame(() => { const stats = calculateDashboardStatistics(); setText('dbTotalMembers',stats.members.total); setText('dbActiveMembers',`${stats.members.active} نشط`); setText('dbInactiveMembers',`${stats.members.inactive} غير نشط`); setText('dbTotalProjects',stats.projects.total); setText('dbAnimeCount',`${stats.projects.anime} أنمي`); setText('dbSeriesCount',`${stats.projects.series} مسلسل`); setText('dbCompletedProjects',stats.projects.completed); setText('dbCompletionRate',`${stats.projects.completionRate}%`); setText('dbTotalEpisodes',stats.episodes.total); setText('dbAvgEpisodesPerProject',stats.episodes.avgPerProject.toFixed(1)); updateFinancialSummaries(stats); updateDashboardCharts(stats); updateDetailedStats(stats); updateRecentActivityDisplay(); }); }
        function calculateDashboardStatistics() {
            const stats = { members:{total:data.members.length,active:0,inactive:0,byRole:{translators:0,editors:0,timers:0,subtitlers:0}}, projects:{total:data.anime.length+data.series.length,anime:data.anime.length,series:data.series.length,completed:0,active:0,upcoming:0,stopped:0,completionRate:0}, episodes:{total:0,avgPerProject:0,byType:{anime:0,series:0}}, financial:{totalCost:0,animeCost:0,seriesCost:0,totalPaid:0,totalRemaining:0,avgCostPerEpisode:{total:0,anime:0,series:0}}, monthlyActivity:[] };
            data.members.forEach(m => { if(m.lastDelivery && Math.floor((new Date()-new Date(m.lastDelivery))/(1000*60*60*24))<=30)stats.members.active++; else stats.members.inactive++; (m.roles||[]).forEach(r=>{if(r==='translator')stats.members.byRole.translators++;if(r==='editor')stats.members.byRole.editors++;if(r==='timer')stats.members.byRole.timers++;if(r==='subtitler')stats.members.byRole.subtitlers++;}); stats.financial.totalPaid+=m.amountReceived||0; });
            [...data.anime,...data.series].forEach(p => { if(p.status==='مكتمل')stats.projects.completed++;else if(p.status==='جارٍ')stats.projects.active++;else if(p.status==='قريباً')stats.projects.upcoming++;else if(p.status==='متوقف')stats.projects.stopped++; const compEps=p.completedEpisodes||0,pCost=p.totalCost||0; stats.episodes.total+=compEps; stats.financial.totalCost+=pCost; if(data.anime.includes(p)){stats.episodes.byType.anime+=compEps;stats.financial.animeCost+=pCost;}else{stats.episodes.byType.series+=compEps;stats.financial.seriesCost+=pCost;} });
            stats.projects.completionRate = stats.projects.total > 0 ? Math.round((stats.projects.completed / stats.projects.total) * 100) : 0;
            stats.episodes.avgPerProject = stats.projects.total > 0 ? stats.episodes.total / stats.projects.total : 0;
            stats.financial.totalRemaining = (data.members.reduce((s,m)=>s+(m.totalFee||0),0))-stats.financial.totalPaid;
            stats.financial.avgCostPerEpisode.total = stats.episodes.total > 0 ? stats.financial.totalCost / stats.episodes.total : 0;
            stats.financial.avgCostPerEpisode.anime = stats.episodes.byType.anime > 0 ? stats.financial.animeCost / stats.episodes.byType.anime : 0;
            stats.financial.avgCostPerEpisode.series = stats.episodes.byType.series > 0 ? stats.financial.seriesCost / stats.episodes.byType.series : 0;
            
            const today=new Date();for(let i=29;i>=0;i--){const d=new Date(today);d.setDate(today.getDate()-i);const sD=new Date(d.setHours(0,0,0,0)).toISOString(),eD=new Date(d.setHours(23,59,59,999)).toISOString();stats.monthlyActivity.push({date:d.toLocaleDateString('ar-EG',{day:'numeric',month:'short'}),count:(data.recentActivityLog || []).filter(l=>l.timestamp>=sD&&l.timestamp<=eD).length});}
            return stats;
        }
        function updateFinancialSummaries(s) { setText('totalProjectsCost',formatMoney(s.financial.totalCost)); setText('totalPaidAmount',formatMoney(s.financial.totalPaid)); setText('totalRemainingAmount',formatMoney(s.financial.totalRemaining)); setText('avgCostPerEpisodeTotal',formatMoney(s.financial.avgCostPerEpisode.total)); setText('animeProjectCount',s.projects.anime); setText('animeCompletedEpisodes',s.episodes.byType.anime); setText('animeTotalCost',formatMoney(s.financial.animeCost)); setText('animeAvgCostPerEpisode',formatMoney(s.financial.avgCostPerEpisode.anime)); setText('seriesProjectCount',s.projects.series); setText('seriesCompletedEpisodes',s.episodes.byType.series); setText('seriesTotalCost',formatMoney(s.financial.seriesCost)); setText('seriesAvgCostPerEpisode',formatMoney(s.financial.avgCostPerEpisode.series)); }
        function updateDashboardCharts(s) { drawChart('activityChart','line',{labels:s.monthlyActivity.map(d=>d.date),datasets:[{label:'الأنشطة',data:s.monthlyActivity.map(d=>d.count),borderColor:getCSSVar('--accent-purple'),backgroundColor:'rgba(139,92,246,0.1)',tension:0.4,fill:true,pointBackgroundColor:getCSSVar('--accent-purple'),pointBorderColor:getCSSVar('--text-main'),pointHoverRadius:6,pointRadius:4}]},{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#fff',bodyColor:'#fff',borderColor:getCSSVar('--accent-purple'),borderWidth:1,padding:10,displayColors:false}},scales:{y:{beginAtZero:true,ticks:{color:getCSSVar('--text-secondary'),stepSize:1},grid:{color:'rgba(255,255,255,0.05)'}},x:{ticks:{color:getCSSVar('--text-secondary'),maxRotation:45,minRotation:45},grid:{display:false}}}},'activityChartInstance'); drawChart('projectStatusChart','doughnut',{labels:['مكتمل','جارٍ','قريباً','متوقف'],datasets:[{data:[s.projects.completed,s.projects.active,s.projects.upcoming,s.projects.stopped],backgroundColor:[getCSSVar('--accent-blue'),getCSSVar('--accent-green'),getCSSVar('--accent-yellow'),getCSSVar('--accent-red')],borderWidth:0}]},{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:getCSSVar('--text-secondary'),padding:15,font:{size:12}}},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#fff',bodyColor:'#fff',borderColor:getCSSVar('--accent-purple'),borderWidth:1,padding:10}}},'projectStatusChartInstance'); drawMonthlyPaymentsChart('monthlyPaymentsChart'); }
        function getCSSVar(varName) { return getComputedStyle(document.documentElement).getPropertyValue(varName); }
        function drawChart(canvasId,type,data,options,instanceName) { const canvas=getEl(canvasId); if(!canvas||!canvas.getContext)return; if(chartInstances[instanceName])chartInstances[instanceName].destroy(); chartInstances[instanceName]=new Chart(canvas.getContext('2d'),{type,data,options}); }
        function updateDetailedStats(s) { getEl('detailedStatsContainer').innerHTML=`<div class="stat-box"><h5><i class="fas fa-users"></i> توزيع الأعضاء</h5><ul><li><span>المترجمون</span><strong>${s.members.byRole.translators}</strong></li><li><span>المدققون</span><strong>${s.members.byRole.editors}</strong></li><li><span>المحاكيون</span><strong>${s.members.byRole.timers}</strong></li><li><span>الموقتون</span><strong>${s.members.byRole.subtitlers}</strong></li></ul></div><div class="stat-box"><h5><i class="fas fa-project-diagram"></i> حالة المشاريع</h5><ul><li><span>جارٍ</span><strong class="text-green">${s.projects.active}</strong></li><li><span>قريباً</span><strong class="text-yellow">${s.projects.upcoming}</strong></li><li><span>متوقف</span><strong class="text-red">${s.projects.stopped}</strong></li><li><span>مكتمل</span><strong class="text-blue">${s.projects.completed}</strong></li></ul></div><div class="stat-box"><h5><i class="fas fa-chart-line"></i> معدلات الأداء</h5><ul><li><span>متوسط الحلقات/مشروع</span><strong>${s.episodes.avgPerProject.toFixed(1)}</strong></li><li><span>نسبة الإنجاز</span><strong>${s.projects.completionRate}%</strong></li><li><span>الأعضاء النشطون</span><strong>${s.members.total>0?Math.round((s.members.active/s.members.total)*100):0}%</strong></li></ul></div><div class="stat-box"><h5><i class="fas fa-money-bill"></i> الملخص المالي</h5><ul><li><span>إجمالي التكلفة</span><strong>${formatMoney(s.financial.totalCost)}</strong></li><li><span>المدفوع</span><strong>${formatMoney(s.financial.totalPaid)}</strong></li><li><span>المستحق</span><strong>${formatMoney(s.financial.totalRemaining)}</strong></li><li><span>نسبة المدفوع</span><strong>${s.financial.totalCost>0?Math.round((s.financial.totalPaid/s.financial.totalCost)*100):0}%</strong></li></ul></div>`; }
        function drawMonthlyPaymentsChart(canvasId) { const monthlyPayments={}; const today=new Date(); for(let i=5;i>=0;i--){const d=new Date(today.getFullYear(),today.getMonth()-i,1);monthlyPayments[d.toLocaleDateString('ar-EG',{year:'numeric',month:'short'})]=0;} data.members.forEach(m=>{if(m.amountReceived&&m.amountReceived>0){const k=Object.keys(monthlyPayments)[0];monthlyPayments[k]+=(m.amountReceived/data.members.length);}}); drawChart(canvasId,'line',{labels:Object.keys(monthlyPayments),datasets:[{label:'المدفوعات',data:Object.values(monthlyPayments),backgroundColor:'rgba(16,185,129,0.2)',borderColor:getCSSVar('--accent-green'),borderWidth:2,fill:true,tension:0.4}]},{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#fff',bodyColor:'#fff',borderColor:getCSSVar('--accent-green'),borderWidth:1,padding:10,callbacks:{label:c=>'المدفوعات: '+formatMoney(c.parsed.y)}}},scales:{y:{beginAtZero:true,ticks:{color:getCSSVar('--text-secondary'),callback:v=>formatMoney(v)},grid:{color:'rgba(255,255,255,0.05)'}},x:{ticks:{color:getCSSVar('--text-secondary')},grid:{display:false}}}},'monthlyPaymentsChartInstance'); }
        
        // ========== REPORTS ==========
        function populateMemberReportDropdown() { requestAnimationFrame(() => { const sel=getEl('reportMemberSelect'); if(!sel)return; const curVal=sel.value; sel.innerHTML='<option value="">اختر عضواً...</option>'; data.members.forEach(m=>{const opt=document.createElement('option');opt.value=m.id;opt.textContent=m.name;sel.appendChild(opt);}); if(Array.from(sel.options).some(o=>o.value===curVal))sel.value=curVal; }); }
        function generateReport(type) { requestAnimationFrame(() => { let html=''; const reportContentEl=getEl('reportContent'); if(type==='monthly')html=generateMonthlyReport(new Date()); else if(type==='projects')html=generateProjectsReport(); else if(type==='memberDetailed'){const mId=getVal('reportMemberSelect');if(!mId){showAlert('يرجى اختيار عضو.', 'warning');if(reportContentEl)reportContentEl.innerHTML='<p class="text-center text-muted">يرجى اختيار عضو.</p>';return;}html=generateDetailedMemberReport(mId);} if(reportContentEl)reportContentEl.innerHTML=html||'<p class="text-center text-muted">لا توجد بيانات.</p>'; }); }
        function generateDetailedMemberReport(memberId) { 
            const member=data.members.find(m=>m.id===memberId); if(!member)return'<p>العضو غير موجود.</p>'; 
            let html=`<div class="report-header"><h3>التقرير المفصل: ${member.name}</h3><p>تاريخ الإنشاء: ${new Date().toLocaleDateString('en-GB')}</p></div>`; 
            html+=`<div class="report-section"><h4>ملخص العمل والمستحقات</h4><ul><li>إجمالي الحلقات المترجمة: <strong>${member.projectTranslatedEpisodes||0}</strong></li><li>إجمالي الحلقات المدققة: <strong>${member.projectEditedEpisodes||0}</strong></li><li>إجمالي الحلقات المحاكية: <strong>${member.projectTimedEpisodes||0}</strong></li><li>إجمالي الحلقات الموقتة: <strong>${member.projectSubtitledEpisodes||0}</strong></li><hr><li>الأجرة الكلية: <strong class="${getMoneyClass(member.totalFee||0)}">${formatMoney(member.totalFee||0)}</strong></li><li>المستلم: <strong class="${getMoneyClass(member.amountReceived||0)}">${formatMoney(member.amountReceived||0)}</strong></li><li>المتبقي: <strong class="${getMoneyClass((member.totalFee||0)-(member.amountReceived||0))}">${formatMoney((member.totalFee||0)-(member.amountReceived||0))}</strong></li></ul></div>`; 
            html+=`<div class="report-section"><h4>تفاصيل المشاريع</h4>`; const rows=[]; 
            [...data.anime,...data.series].forEach(p=>{ let pType=data.anime.some(a=>a.id===p.id)?'أنمي':'مسلسل', compInP=p.completedEpisodes||0, rolesData=[{r:'مترجم',pid:p.translatorId,price:p.translationPrice,bonus:p.translationBonus},{r:'مدقق',pid:p.editorId,price:p.editingPrice,bonus:p.editingBonus},{r:'محاكي',pid:p.timerId,price:p.timerPrice,bonus:p.timerBonus},{r:'موقت',pid:p.subtitlerId,price:p.subtitlerPrice,bonus:p.subtitlerBonus}]; rolesData.forEach(rd=>{if(rd.pid===member.id&&compInP>0){let base=compInP*(rd.price||0),bonus=rd.bonus||0;rows.push(`<tr><td>${p.name} (${pType})</td><td>${rd.r}</td><td>${compInP}</td><td class="${getMoneyClass(base)}">${formatMoney(base)}</td><td class="${getMoneyClass(bonus)}">${formatMoney(bonus)}</td><td class="${getMoneyClass(base+bonus)}">${formatMoney(base+bonus)}</td></tr>`);}}); }); 
            if(rows.length>0)html+=`<div class="table-container"><table><thead><tr><th>المشروع</th><th>الدور</th><th>الحلقات</th><th>الأجرة الأساسية</th><th>إضافي/مخصوم</th><th>الإجمالي</th></tr></thead><tbody>${rows.join('')}</tbody></table></div>`; else html+=`<p>لم يعمل هذا العضو على أي مشاريع مكتملة الحلقات.</p>`; html+=`</div>`; return html; 
        }
        function generateMonthlyReport(date) {
            const month=date.getMonth(),year=date.getFullYear(),monthName=date.toLocaleDateString('ar-SA',{month:'long',year:'numeric'});
            let html=`<div class="report-header"><h3>التقرير الشهري لـ ${monthName}</h3><p>تاريخ الإنشاء: ${new Date().toLocaleDateString('en-GB')}</p></div>`;
            const monthlyStats=calculateDashboardStatistics(); html+=`<div class="report-section"><h4>ملخص الشهر</h4><ul><li>المشاريع النشطة: <strong>${monthlyStats.projects.active}</strong></li><li>الحلقات المنجزة (إجمالي): <strong>${monthlyStats.episodes.total}</strong></li><li>المدفوعات (إجمالي): <strong>${formatMoney(monthlyStats.financial.totalPaid)}</strong></li></ul></div>`;
            const projectsThisMonthIds=new Set();
            (data.recentActivityLog || []).forEach(log=>{
                const logDate=new Date(log.timestamp);
                if(logDate.getMonth()===month&&logDate.getFullYear()===year && log.message.includes('مشروع')){
                    const match=log.message.match(/مشروع \((anime|series)\) (.*?)(:|$)/);
                    if(match&&match[2]){
                        const pName=match[2].trim();
                        const project=[...data.anime,...data.series].find(p=>p.name===pName);
                        if(project)projectsThisMonthIds.add(project.id);
                    }
                }
            });
            const projectsWorked=[...data.anime,...data.series].filter(p=>projectsThisMonthIds.has(p.id));
            html+=`<div class="report-section"><h4>المشاريع التي تم العمل عليها هذا الشهر (${projectsWorked.length})</h4>`; if(projectsWorked.length>0){html+=`<div class="table-container"><table><thead><tr><th>المشروع</th><th>النوع</th><th>التقدم</th><th>الحالة</th></tr></thead><tbody>`;projectsWorked.forEach(p=>{const type=data.anime.some(a=>a.id===p.id)?'أنمي':'مسلسل',perc=p.totalEpisodes>0?((p.completedEpisodes/p.totalEpisodes)*100).toFixed(1):0;html+=`<tr><td>${p.name}</td><td>${type}</td><td>${p.completedEpisodes}/${p.totalEpisodes} (${perc}%)</td><td>${p.status}</td></tr>`;});html+=`</tbody></table></div>`;}else html+=`<p>لم يتم العمل على مشاريع مسجلة هذا الشهر.</p>`; html+=`</div>`; return html;
        }
        function generateProjectsReport() { const activeP=[...data.anime,...data.series].filter(p=>p.status==='جارٍ'),completedP=[...data.anime,...data.series].filter(p=>p.status==='مكتمل'),upcomingP=[...data.anime,...data.series].filter(p=>p.status==='قريباً'); let html=`<div class="report-header"><h3>تقرير حالة المشاريع</h3><p>تاريخ الإنشاء: ${new Date().toLocaleDateString('en-GB')}</p></div>`; const genTable=(title,list)=>{let tHtml=`<div class="report-section"><h4>${title} (${list.length})</h4>`;if(list.length===0){tHtml+=`<p>لا توجد مشاريع.</p></div>`;return tHtml;}tHtml+=`<div class="table-container"><table><thead><tr><th>المشروع</th><th>النوع</th><th>التقدم</th><th>المترجم</th><th>المدقق</th><th>المحاكي</th><th>الموقت</th><th>التكلفة</th></tr></thead><tbody>`;list.forEach(p=>{const perc=p.totalEpisodes>0?((p.completedEpisodes/p.totalEpisodes)*100).toFixed(1):0,type=data.anime.some(a=>a.id===p.id)?'أنمي':'مسلسل',tr=p.translatorId?data.members.find(m=>m.id===p.translatorId)?.name:'-',ed=p.editorId?data.members.find(m=>m.id===p.editorId)?.name:'-',ti=p.timerId?data.members.find(m=>m.id===p.timerId)?.name:'-',su=p.subtitlerId?data.members.find(m=>m.id===p.subtitlerId)?.name:'-';tHtml+=`<tr><td>${p.name}</td><td>${type}</td><td>${p.completedEpisodes}/${p.totalEpisodes} (${perc}%)</td><td>${tr}</td><td>${ed}</td><td>${ti}</td><td>${su}</td><td>${formatMoney(p.totalCost||0)}</td></tr>`;});tHtml+=`</tbody></table></div></div>`;return tHtml;}; html+=genTable('المشاريع النشطة',activeP);html+=genTable('المشاريع المكتملة',completedP);html+=genTable('المشاريع القادمة',upcomingP); return html;}
        function printReport() { const content=getEl('reportContent').innerHTML; if(!content||content.includes("اختر نوع التقرير")){showAlert('يرجى إنشاء تقرير أولاً.','warning');return;} window.print(); }
        function saveReportAsHTML() { const content=getEl('reportContent').innerHTML; if(!content||content.trim()===''||content.includes("اختر نوع التقرير")){showAlert('يجب إنشاء تقرير أولاً.','warning');return;} const fullHtml=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تقرير - ${new Date().toLocaleDateString('ar-EG')}</title><style>body{font-family:Arial,sans-serif;direction:rtl;padding:20px;margin:0 auto;max-width:1000px;background-color:var(--bg-primary-user, #0f0f0f);color:var(--text-main, #fff);} :root{--border-color:#333;--accent-green:#10b981;--accent-yellow:#f59e0b;--accent-red:#ef4444;--report-header-bg-var:#1a1a1a;--report-table-th-bg-var:#242424;} table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid var(--border-color);padding:8px;text-align:right}th{background-color:var(--report-table-th-bg-var)}.report-header{background:var(--report-header-bg-var);padding:20px;margin-bottom:20px;border-radius:8px;border:1px solid var(--border-color)}.report-section{margin:20px 0;padding:15px;border:1px solid var(--border-color);border-radius:8px}.money-positive{color:var(--accent-green)}.money-zero{color:var(--accent-yellow)}.money-negative{color:var(--accent-red)}.table-container{overflow-x:auto}</style></head><body><h1>ReviveSubs</h1>${content}<hr><p>التاريخ: ${new Date().toLocaleString('en-US')}</p></body></html>`; downloadFile(fullHtml,`ReviveSubs_Report_${new Date().toISOString().split('T')[0]}.html`,'text/html');}
        
        // ========== SETTINGS ==========
        function loadSettings() { 
            requestAnimationFrame(() => { 
                setVal('headerLogoUrl', data.settings.headerLogoUrl || ""); 
                setVal('headerLinkWebsiteUrl', data.settings.headerLinkWebsiteUrl || ""); 
                setVal('headerLinkDiscordUrl', data.settings.headerLinkDiscordUrl || ""); 
                setVal('headerLinkTelegramUrl', data.settings.headerLinkTelegramUrl || ""); 
                setVal('headerLinkDriveUrl', data.settings.headerLinkDriveUrl || ""); 
                updateHeaderDisplay(); 
                updateHeaderSocialLinks(); 
                populateMemberReportDropdown(); 
            }); 
        }
        function updateSettings() { 
            data.settings.headerLogoUrl = getVal('headerLogoUrl'); 
            data.settings.headerLinkWebsiteUrl = getVal('headerLinkWebsiteUrl'); 
            data.settings.headerLinkDiscordUrl = getVal('headerLinkDiscordUrl'); 
            data.settings.headerLinkTelegramUrl = getVal('headerLinkTelegramUrl'); 
            data.settings.headerLinkDriveUrl = getVal('headerLinkDriveUrl'); 
            updateHeaderDisplay(); 
            updateHeaderSocialLinks(); 
            unsavedChanges = true; 
            saveData().then(success => { if(!success) unsavedChanges = true; }); 
            requestAnimationFrame(() => showAlert('تم حفظ الإعدادات بنجاح.', 'success'));
            logRecentActivity('تم تحديث الإعدادات.');
        }

        function updateHeaderDisplay() {
            requestAnimationFrame(() => {
                const headerElement = document.querySelector('.header');
                const logoUrl = data.settings.headerLogoUrl;

                if (logoUrl && isValidUrl(logoUrl)) {
                    headerElement.style.backgroundImage = `url('${logoUrl}')`;
                    headerElement.classList.add('has-background-image');
                } else {
                    headerElement.style.backgroundImage = ''; 
                    headerElement.style.background = `linear-gradient(135deg, var(--header-gradient-start) 0%, var(--header-gradient-end) 100%)`;
                    headerElement.classList.remove('has-background-image');
                    headerElement.style.height = ''; 
                    headerElement.style.minHeight = '80px'; 
                }
            });
        }

        function updateHeaderSocialLinks() {
            requestAnimationFrame(() => {
                getEl('headerLinkWebsite').href = data.settings.headerLinkWebsiteUrl || "#";
                getEl('headerLinkDiscord').href = data.settings.headerLinkDiscordUrl || "#";
                getEl('headerLinkTelegram').href = data.settings.headerLinkTelegramUrl || "#";
                getEl('headerLinkDrive').href = data.settings.headerLinkDriveUrl || "#";
            });
        }

        // ========== GOOGLE DRIVE INTEGRATION FUNCTIONS ==========

        function handleGoogleApiLibraryLoad() {
            if (googleApiLoadInitiated) return;
            googleApiLoadInitiated = true;

            if (typeof gapi !== 'undefined') {
                gapi.load('client:auth2', initGoogleClient);
            } else {
                console.error('Google API library (gapi) not loaded.');
                showAlert('مكتبة Google API غير محملة. قد لا تعمل ميزات السحابة.', 'danger');
            }
        }

        async function initGoogleClient() {
            try {
                await gapi.client.init({
                    clientId: GOOGLE_CLIENT_ID,
                    discoveryDocs: DISCOVERY_DOCS,
                    scope: SCOPES
                });
                isGoogleApiLoadedAndInitialized = true;
                googleAuth = gapi.auth2.getAuthInstance();
                googleAuth.isSignedIn.listen(updateGoogleSignInStatus);
                updateGoogleSignInStatus(googleAuth.isSignedIn.get());
                console.log("Google API Client Initialized.");
            } catch (error) {
                console.error("Error initializing Google API client:", error);
                isGoogleApiLoadedAndInitialized = false;
                showAlert('خطأ في تهيئة Google API: ' + (error.details || error.message || 'غير معروف'), 'danger');
            }
        }
        
        function updateGoogleSignInStatus(isSignedIn) {
            // You can update UI elements based on sign-in status here if needed
            console.log("Google Sign-In Status:", isSignedIn);
            // Example: if (getEl('googleSignInBtn')) getEl('googleSignInBtn').classList.toggle('hidden', isSignedIn);
        }

        async function ensureGoogleSignIn() {
            if (!isGoogleApiLoadedAndInitialized) {
                showAlert('Google API غير جاهز. حاول مرة أخرى.', 'warning');
                return false;
            }
            if (!googleAuth.isSignedIn.get()) {
                try {
                    await googleAuth.signIn();
                    if (googleAuth.isSignedIn.get()) {
                        showAlert('تم تسجيل الدخول إلى Google بنجاح.', 'success');
                        return true;
                    } else {
                         showAlert('فشل تسجيل الدخول إلى Google. يرجى المحاولة مرة أخرى.', 'warning');
                        return false;
                    }
                } catch (error) {
                    console.error("Google Sign-In Error:", error);
                    showAlert('خطأ أثناء تسجيل الدخول إلى Google: ' + (error.error || 'غير معروف'), 'danger');
                    return false;
                }
            }
            return true;
        }

        async function getOrCreateAppFolder() {
            if (!await ensureGoogleSignIn()) return null;

            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id)',
                    spaces: 'drive'
                });
                if (response.result.files && response.result.files.length > 0) {
                    return response.result.files[0].id;
                } else {
                    const fileMetadata = {
                        name: APP_FOLDER_NAME,
                        mimeType: 'application/vnd.google-apps.folder'
                    };
                    const createResponse = await gapi.client.drive.files.create({
                        resource: fileMetadata,
                        fields: 'id'
                    });
                    return createResponse.result.id;
                }
            } catch (error) {
                console.error("Error getting/creating app folder:", error);
                showAlert('خطأ في الوصول إلى مجلد التطبيق على Google Drive.', 'danger');
                return null;
            }
        }

        async function listAppFolderFiles(folderId) {
            if (!await ensureGoogleSignIn()) return [];
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and trashed=false and mimeType='application/json'`,
                    fields: 'files(id, name, createdTime)',
                    orderBy: 'createdTime desc' // Newest first for display, will sort for rotation
                });
                return response.result.files || [];
            } catch (error) {
                console.error("Error listing files in app folder:", error);
                showAlert('خطأ في جلب قائمة النسخ الاحتياطية من Google Drive.', 'danger');
                return [];
            }
        }

        async function deleteDriveFile(fileId) {
            if (!await ensureGoogleSignIn()) return false;
            try {
                await gapi.client.drive.files.delete({ fileId: fileId });
                console.log("Deleted file:", fileId);
                return true;
            } catch (error) {
                console.error("Error deleting file from Drive:", error);
                showAlert(`فشل حذف الملف القديم (${fileId}) من Google Drive.`, 'danger');
                return false;
            }
        }

        async function uploadToGoogleDriveWithRotation() {
            if (!await ensureGoogleSignIn()) return;
            closeModal('globalExportDropdown'); // Close the dropdown menu
            showAlert('جاري الرفع إلى Google Drive...', 'info');

            const folderId = await getOrCreateAppFolder();
            if (!folderId) return;

            const filesInFolder = await listAppFolderFiles(folderId);
            // Sort by createdTime ascending (oldest first) for rotation logic
            filesInFolder.sort((a, b) => new Date(a.createdTime) - new Date(b.createdTime)); 

            if (filesInFolder.length >= MAX_DRIVE_BACKUPS) {
                const oldestFile = filesInFolder[0]; // Oldest is at the start after sorting
                const deleted = await deleteDriveFile(oldestFile.id);
                if (deleted) {
                    showAlert(`تم حذف النسخة الاحتياطية الأقدم: ${oldestFile.name}`, 'info', 4000);
                } else {
                    showAlert(`فشل حذف النسخة الأقدم. قد يتجاوز عدد النسخ الحد المسموح به.`, 'warning');
                    // Optionally, decide if you want to proceed with upload anyway or stop.
                    // For now, we proceed.
                }
            }

            const fileName = `ReviveSubs_Backup_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            const fileContent = JSON.stringify(data, null, 2);
            const file = new Blob([fileContent], { type: 'application/json' });

            const metadata = {
                name: fileName,
                mimeType: 'application/json',
                parents: [folderId]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            try {
                const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token }),
                    body: form,
                });
                const uploadedFile = await res.json();
                if (uploadedFile.id) {
                    logRecentActivity(`رفع نسخة احتياطية سحابية: ${fileName}`);
                    showAlert(`تم رفع النسخة الاحتياطية "${fileName}" إلى Google Drive بنجاح!`, 'success');
                } else {
                    throw new Error(uploadedFile.error?.message || "فشل الرفع غير معروف.");
                }
            } catch (error) {
                console.error("Error uploading to Drive:", error);
                showAlert(`فشل رفع النسخة الاحتياطية إلى Google Drive: ${error.message}`, 'danger');
            }
        }
        
        async function listGoogleDriveBackupsForImport() {
            if (!await ensureGoogleSignIn()) return;
            closeModal('globalImportDropdown'); // Close the dropdown menu
            setStyle('googleDriveBackupsModal', 'display', 'block');
            const listContainer = getEl('googleDriveBackupsListContainer');
            listContainer.innerHTML = '<div class="spinner"></div>';

            const folderId = await getOrCreateAppFolder();
            if (!folderId) {
                listContainer.innerHTML = '<p class="text-center text-muted">لا يمكن الوصول إلى مجلد النسخ الاحتياطية.</p>';
                return;
            }
            
            const files = await listAppFolderFiles(folderId);
            // Files are already sorted newest first by listAppFolderFiles

            if (files.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-muted">لا توجد نسخ احتياطية سحابية.</p>';
                return;
            }

            let html = '<ul style="list-style: none; padding: 0;">';
            files.forEach(file => {
                html += `<li style="padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${file.name}</strong><br>
                                <small class="text-muted">تاريخ الإنشاء: ${formatDateTime(file.createdTime)}</small>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="downloadAndImportFromDrive('${file.id}', '${file.name.replace(/'/g, "\\'")}')">استيراد</button>
                         </li>`;
            });
            html += '</ul>';
            listContainer.innerHTML = html;
        }

        async function downloadAndImportFromDrive(fileId, fileName) {
            if (!await ensureGoogleSignIn()) return;
            if (!confirm(`هل أنت متأكد أنك تريد استيراد النسخة الاحتياطية "${fileName}"؟ سيتم الكتابة فوق البيانات الحالية.`)) return;
            
            closeModal('googleDriveBackupsModal');
            showAlert(`جاري تحميل واستيراد "${fileName}"...`, 'info');

            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                const imported = response.result; 
                
                const defaultStructure = initializeDefaultDataStructure(false);
                if (imported && imported.settings && Array.isArray(imported.members) && Array.isArray(imported.anime) && Array.isArray(imported.series)) {
                    data = { ...defaultStructure, ...imported }; 
                    data.settings = { ...defaultStructure.settings, ...(imported.settings || {}) };
                     if (!Array.isArray(data.recentActivityLog)) data.recentActivityLog = []; 

                    await saveData();
                    unsavedChanges = false;
                    logRecentActivity(`استيراد نسخة سحابية: ${fileName}`);
                    showAlert(`تم استيراد "${fileName}" بنجاح.`, 'success');
                    updateAllDisplays();
                } else {
                    showAlert('ملف الاستيراد السحابي غير صالح أو بتنسيق غير متوقع.', 'danger');
                }
            } catch (error) {
                console.error("Error downloading/importing from Drive:", error);
                showAlert(`خطأ أثناء استيراد النسخة السحابية: ${error.result?.error?.message || error.message}`, 'danger');
            }
        }
        
        // ========== DROPDOWN UI CONTROL ==========
        function setupDropdowns() {
            const dropdownToggles = [
                { btnId: 'globalImportToggleBtn', menuId: 'globalImportDropdown' },
                { btnId: 'globalExportToggleBtn', menuId: 'globalExportDropdown' }
            ];

            dropdownToggles.forEach(pair => {
                const btn = getEl(pair.btnId);
                const menu = getEl(pair.menuId);

                if (btn && menu) {
                    btn.addEventListener('click', (event) => {
                        event.stopPropagation(); // Prevent click from immediately closing
                        const isHidden = menu.classList.contains('hidden');
                        
                        // Close all other dropdowns first
                        dropdownToggles.forEach(otherPair => {
                            if (otherPair.menuId !== pair.menuId) {
                                getEl(otherPair.menuId)?.classList.add('hidden');
                            }
                        });
                        // Then toggle the current one
                        if (isHidden) {
                            menu.classList.remove('hidden');
                        } else {
                            menu.classList.add('hidden');
                        }
                    });
                }
            });

            // Close dropdowns if clicked outside
            document.addEventListener('click', (event) => {
                dropdownToggles.forEach(pair => {
                    const btn = getEl(pair.btnId);
                    const menu = getEl(pair.menuId);
                    if (menu && !menu.classList.contains('hidden')) {
                        // Check if the click was outside the menu AND its toggle button
                        if (!menu.contains(event.target) && (!btn || !btn.contains(event.target))) {
                            menu.classList.add('hidden');
                        }
                    }
                });
            });
        }


    </script>
</body>
</html>